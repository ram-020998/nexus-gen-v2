{% extends "base.html" %}

{% block title %}Process Details - {{ request.reference_id }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>Process Details</h2>
                <div class="d-flex gap-2">
                    {% if request.action_type == 'breakdown' %}
                    <a href="{{ url_for('breakdown.view_results', request_id=request.id) }}" class="btn btn-outline-secondary">
                        View Results
                    </a>
                    {% endif %}
                    <button class="btn btn-outline-secondary" onclick="reprocessRequest({{ request.id }})">
                        ‚Üª Reprocess
                    </button>
                </div>
            </div>

            <!-- 1. Request Information & Agent Metadata -->
            <div class="section-card mb-4">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Request Details</h6>
                        <hr>
                        <div class="metadata-grid">
                            <div><strong>Type:</strong> {{ request.action_type.title() }}</div>
                            <div><strong>Status:</strong> {{ request.status.title() }}</div>
                            {% if request.filename %}
                            <div><strong>File:</strong> {{ request.filename }}</div>
                            {% endif %}
                            <div><strong>Created:</strong> {{ request.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</div>
                            <div><strong>Updated:</strong> {{ request.updated_at.strftime('%Y-%m-%d %H:%M:%S') }}</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6>Agent Configuration</h6>
                        <hr>
                        <div class="metadata-grid">
                            <div><strong>Agent:</strong> {{ request.agent_name or 'N/A' }}</div>
                            <div><strong>Model:</strong> {{ request.model_name or 'N/A' }}</div>
                            {% if request.parameters %}
                                {% set params = request.parameters | from_json %}
                                <div><strong>Temperature:</strong> {{ params.temperature or 'N/A' }}</div>
                                <div><strong>Top P:</strong> {{ params.topP or 'N/A' }}</div>
                                <div><strong>Max Tokens:</strong> {{ params.maxTokens or 'N/A' }}</div>
                            {% endif %}
                            <div><strong>KB ID:</strong> WAQ6NJLGKN</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 2. Result Confidence Indicators -->
            <!-- <div class="section-card mb-4">
                <h5>üìä Result Confidence Indicators</h5>
                <hr>
                <div class="confidence-badges">
                    {% if request.rag_similarity_avg %}
                    <span class="badge bg-secondary">RAG Similarity: {{ "%.2f"|format(request.rag_similarity_avg) }} {% if request.rag_similarity_avg > 0.7 %}‚úÖ{% elif request.rag_similarity_avg > 0.4 %}‚ö†Ô∏è{% else %}‚ùå{% endif %}</span>
                    {% endif %}
                    
                    <span class="badge bg-secondary">Output Format: {% if request.json_valid %}Valid JSON ‚úÖ{% else %}Invalid JSON ‚ùå{% endif %}</span>
                    
                    {% if request.total_time %}
                    <span class="badge bg-secondary">Processing Time: {{ request.total_time }}s ‚öôÔ∏è</span>
                    {% endif %}
                    
                    <span class="badge bg-secondary">Error Recovery: {% if request.error_log %}Yes{% else %}No{% endif %}</span>
                </div>
            </div> -->

            <!-- 3. Processing Timeline -->
            <!-- <div class="section-card mb-4">
                <h5>üß≠ Processing Timeline</h5>
                <hr>
                {% if timeline_data %}
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Step</th>
                                <th>Start Time</th>
                                <th>End Time</th>
                                <th>Duration (sec)</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for step in timeline_data %}
                            <tr>
                                <td>{{ step.step }}</td>
                                <td>{{ step.start_time }}</td>
                                <td>{{ step.end_time }}</td>
                                <td>{{ step.duration }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-muted">No timeline data available</p>
                {% endif %}
            </div> -->

            <!-- 4. RAG Query & Response -->
            {% if request.rag_query or request.rag_response %}
            <div class="section-card mb-4">
                <h5>üîç RAG Query & Response</h5>
                <hr>
                {% if request.rag_query %}
                <div class="mb-3">
                    <h6>Query Sent to Bedrock</h6>
                    <div class="output-container">
                        <pre style="max-height: 300px; overflow-y: auto; white-space: pre-wrap; word-wrap: break-word;">{{ request.rag_query }}</pre>
                    </div>
                </div>
                {% endif %}
                {% if request.rag_response %}
                <div>
                    <h6>Bedrock Response</h6>
                    <div class="output-container">
                        <pre class="json-output" style="max-height: 400px; overflow-y: auto;">{{ request.rag_response | format_json }}</pre>
                    </div>
                </div>
                {% endif %}
            </div>
            {% endif %}

            <!-- 5. Q Agent Prompt & Response -->
            {% if request.q_agent_prompt %}
            <div class="section-card mb-4">
                <h5>ü§ñ Q Agent Prompt & Response</h5>
                <hr>
                <div class="mb-3">
                    <h6>Prompt Sent to Q Agent</h6>
                    <div class="output-container">
                        <pre style="max-height: 300px; overflow-y: auto; white-space: pre-wrap; word-wrap: break-word;">{{ request.q_agent_prompt }}</pre>
                    </div>
                </div>
                {% if request.raw_agent_output %}
                <div>
                    <h6>Raw Q Agent Output</h6>
                    <div class="output-container">
                        <pre style="max-height: 400px; overflow-y: auto;">{{ request.raw_agent_output }}</pre>
                    </div>
                </div>
                {% endif %}
                {% if request.final_output %}
                <div>
                    <br>
                    <h6>Processed Q Agent Output</h6>
                    <div class="output-container">
                        {% if request.final_output.strip().startswith('{') %}
                            <pre class="json-output">{{ request.final_output | format_json }}</pre>
                        {% else %}
                            <pre>{{ request.final_output }}</pre>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
            </div>
            {% endif %}
        </div>
    </div>
</div>



<script>
function downloadArtifact(type, requestId) {
    const url = `/process/download/${type}/${requestId}`;
    const link = document.createElement('a');
    link.href = url;
    link.download = `${type}_artifact_${requestId}.json`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

function reprocessRequest(requestId) {
    if (confirm('Are you sure you want to reprocess this request? This will create a new request with the same input.')) {
        fetch(`/process/reprocess/${requestId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Request reprocessing started. You will be redirected to the new request.');
                window.location.href = `/process/details/${data.new_request_id}`;
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while reprocessing the request.');
        });
    }
}
</script>
{% endblock %}
