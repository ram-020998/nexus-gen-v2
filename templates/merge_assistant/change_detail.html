{% extends "base.html" %}

{% block title %}Change Detail - {{ change.name }} - {{ session.reference_id }} - NexusGen{% endblock %}

{% block breadcrumbs %}
<nav aria-label="breadcrumb" class="breadcrumb-nav">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{{ url_for('dashboard') }}"><i class="fas fa-home"></i> Home</a></li>
        <li class="breadcrumb-item"><a href="{{ url_for('merge_assistant.list_sessions') }}">Merge Assistant</a></li>
        <li class="breadcrumb-item"><a href="{{ url_for('merge_assistant.view_summary', session_id=session.id) }}">{{ session.reference_id }}</a></li>
        <li class="breadcrumb-item active" aria-current="page">Change {{ change_index + 1 }} of {{ total_changes }}</li>
    </ol>
</nav>
{% endblock %}

{% block page_title %}Change Detail{% endblock %}
{% block page_subtitle %}Review and merge vendor changes into your customized version{% endblock %}

{% block content %}
<!-- Progress Bar -->
<div class="row mb-4">
    <div class="col-12">
        <div class="progress-card">
            <div class="progress-header">
                <div class="progress-info">
                    <span class="progress-label">Progress</span>
                    <span class="progress-count">{{ change_index + 1 }} of {{ total_changes }}</span>
                </div>
                <div class="progress-percentage">
                    {{ ((change_index + 1) / total_changes * 100)|int }}%
                </div>
            </div>
            <div class="progress-bar-container">
                <div class="progress-bar-fill" style="width: {{ ((change_index + 1) / total_changes * 100) }}%"></div>
            </div>
        </div>
    </div>
</div>

<!-- Object Header -->
<div class="row mb-4">
    <div class="col-12">
        <div class="object-header-card">
            <div class="object-icon-wrapper">
                <div class="object-icon classification-{{ change.classification|lower }}">
                    {% if change.type == 'Interface' %}
                        <i class="fas fa-window-maximize"></i>
                    {% elif change.type == 'Process Model' %}
                        <i class="fas fa-project-diagram"></i>
                    {% elif change.type == 'Record Type' %}
                        <i class="fas fa-database"></i>
                    {% elif change.type == 'Expression Rule' %}
                        <i class="fas fa-code"></i>
                    {% else %}
                        <i class="fas fa-file"></i>
                    {% endif %}
                </div>
            </div>
            <div class="object-details">
                <h2>{{ change.name }}</h2>
                <div class="object-meta">
                    <span class="object-type">
                        <i class="fas fa-tag"></i> {{ change.type }}
                    </span>
                    <span class="object-classification classification-{{ change.classification|lower }}">
                        <i class="fas fa-circle"></i> {{ change.classification|replace('_', ' ')|title }}
                    </span>
                    {% if change.review_status %}
                    <span class="review-status status-{{ change.review_status }}">
                        {% if change.review_status == 'reviewed' %}
                            <i class="fas fa-check-circle"></i> Reviewed
                        {% elif change.review_status == 'skipped' %}
                            <i class="fas fa-forward"></i> Skipped
                        {% else %}
                            <i class="fas fa-clock"></i> Pending
                        {% endif %}
                    </span>
                    {% endif %}
                </div>
            </div>
            
            <!-- Jump to Change Dropdown -->
            <div class="jump-to-change">
                <button class="btn btn-outline-secondary dropdown-toggle" type="button" 
                        id="jumpToDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="fas fa-list"></i> Jump to Change
                </button>
                <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="jumpToDropdown" 
                    style="max-height: 400px; overflow-y: auto;">
                    {% for i in range(total_changes) %}
                    <li>
                        <a class="dropdown-item {% if i == change_index %}active{% endif %}" 
                           href="{{ url_for('merge_assistant.view_change', session_id=session.id, change_index=i) }}">
                            Change {{ i + 1 }}
                        </a>
                    </li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- Main Content Area -->
<div class="row">
    <!-- Left Column: Change Details -->
    <div class="col-lg-9">
        {% if change.classification == 'NO_CONFLICT' %}
            <!-- NO_CONFLICT: Show vendor changes with guidance -->
            <div class="change-section">
                <div class="section-header">
                    <h4><i class="fas fa-info-circle"></i> Vendor Changes</h4>
                    <p class="section-description">
                        The vendor made changes to this object. Review the changes below and incorporate them into your customized version.
                    </p>
                </div>
                
                <div class="vendor-changes-card">
                    {% if change.type == 'Process Model' and change.process_model_data and change.process_model_data.has_enhanced_data %}
                        <!-- Enhanced Process Model View -->
                        {% include 'merge_assistant/_process_model_summary.html' %}
                    {% else %}
                        <!-- Standard View -->
                        {% if change.merge_guidance and change.merge_guidance.vendor_additions %}
                        <div class="guidance-section">
                            <h5><i class="fas fa-plus-circle text-success"></i> New Additions</h5>
                            <p class="guidance-description">The vendor added the following new features or code:</p>
                            <div class="additions-list">
                                {% for addition in change.merge_guidance.vendor_additions %}
                                <div class="addition-item">
                                    <div class="addition-header">
                                        <span class="addition-type">{{ addition.type }}</span>
                                        {% if addition.location %}
                                        <span class="addition-location">{{ addition.location }}</span>
                                        {% endif %}
                                    </div>
                                    {% if addition.code %}
                                    <pre class="code-block"><code>{{ addition.code }}</code></pre>
                                    {% endif %}
                                    {% if addition.description %}
                                    <p class="addition-description">{{ addition.description }}</p>
                                    {% endif %}
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                        
                        {% if change.merge_guidance and change.merge_guidance.vendor_modifications %}
                        <div class="guidance-section">
                            <h5><i class="fas fa-edit text-warning"></i> Modifications</h5>
                            <p class="guidance-description">The vendor modified existing functionality:</p>
                            <div class="modifications-list">
                                {% for modification in change.merge_guidance.vendor_modifications %}
                                <div class="modification-item">
                                    <div class="modification-header">
                                        <span class="modification-type">{{ modification.type }}</span>
                                    </div>
                                    {% if modification.before and modification.after %}
                                    <div class="diff-view">
                                        <div class="diff-column">
                                            <div class="diff-label">Before</div>
                                            <pre class="code-block"><code>{{ modification.before }}</code></pre>
                                        </div>
                                        <div class="diff-column">
                                            <div class="diff-label">After</div>
                                            <pre class="code-block"><code>{{ modification.after }}</code></pre>
                                        </div>
                                    </div>
                                    {% endif %}
                                    {% if modification.description %}
                                    <p class="modification-description">{{ modification.description }}</p>
                                    {% endif %}
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                        
                        <!-- Display full SAIL code if available -->
                        {% if change.vendor_object and change.vendor_object.sail_code %}
                        <div class="guidance-section">
                            <h5><i class="fas fa-code"></i> SAIL Code</h5>
                            <p class="guidance-description">Full SAIL code from the vendor version:</p>
                            <div style="max-height: 500px; overflow-y: auto; border: 1px solid #444; border-radius: 4px;">
                                <pre class="code-block" style="margin: 0;"><code>{{ change.vendor_object.sail_code }}</code></pre>
                            </div>
                        </div>
                        {% endif %}
                    {% endif %}
                </div>
            </div>
        
        {% elif change.classification == 'CONFLICT' %}
            <!-- CONFLICT: Show three-way diff -->
            <div class="change-section">
                <div class="section-header">
                    <h4><i class="fas fa-exclamation-triangle text-danger"></i> Conflicting Changes</h4>
                    <p class="section-description">
                        Both you and the vendor modified this object. Review the three-way comparison below to understand all changes.
                    </p>
                </div>
                
                <div class="three-way-diff-card">
                    <div class="diff-tabs">
                        <button class="diff-tab active" data-tab="side-by-side">
                            <i class="fas fa-columns"></i> Side-by-Side
                        </button>
                        <button class="diff-tab" data-tab="unified">
                            <i class="fas fa-align-left"></i> Unified
                        </button>
                        {% if change.type == 'Process Model' and change.process_model_data and change.process_model_data.has_enhanced_data %}
                        <button class="diff-tab" data-tab="flow-diagram">
                            <i class="fas fa-project-diagram"></i> Flow Diagram
                        </button>
                        {% endif %}
                    </div>
                    
                    <!-- Side-by-Side View -->
                    <div class="diff-content active" id="side-by-side">
                        {% if change.type == 'Process Model' and change.process_model_data and change.process_model_data.has_enhanced_data %}
                            <!-- Enhanced Process Model View -->
                            {% include 'merge_assistant/_process_model_three_way.html' %}
                        {% else %}
                            <!-- Standard Three-Way View -->
                            <div class="three-way-grid">
                                <!-- Base (A) -->
                                <div class="diff-panel">
                                    <div class="diff-panel-header package-a">
                                        <i class="fas fa-box"></i> Base (A)
                                    </div>
                                    <div class="diff-panel-body" style="max-height: 600px; overflow-y: auto;">
                                        {% if change.base_object and change.base_object.sail_code %}
                                        <pre class="code-block" style="margin: 0;"><code>{{ change.base_object.sail_code }}</code></pre>
                                        {% elif change.base_object %}
                                        <div class="object-properties">
                                            {% for key, value in change.base_object.items() %}
                                            {% if key not in ['uuid', 'sail_code'] %}
                                            <div class="property-item">
                                                <span class="property-key">{{ key }}:</span>
                                                <span class="property-value">{{ value }}</span>
                                            </div>
                                            {% endif %}
                                            {% endfor %}
                                        </div>
                                        {% else %}
                                        <div class="empty-state">
                                            <i class="fas fa-inbox"></i>
                                            <p>Object did not exist in base version</p>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <!-- Customer (B) -->
                                <div class="diff-panel">
                                    <div class="diff-panel-header package-b">
                                        <i class="fas fa-box"></i> Customer (B)
                                    </div>
                                    <div class="diff-panel-body" style="max-height: 600px; overflow-y: auto;">
                                        {% if change.customer_object and change.customer_object.sail_code %}
                                        <pre class="code-block" style="margin: 0;"><code>{{ change.customer_object.sail_code }}</code></pre>
                                        {% elif change.customer_object %}
                                        <div class="object-properties">
                                            {% for key, value in change.customer_object.items() %}
                                            {% if key not in ['uuid', 'sail_code'] %}
                                            <div class="property-item">
                                                <span class="property-key">{{ key }}:</span>
                                                <span class="property-value">{{ value }}</span>
                                            </div>
                                            {% endif %}
                                            {% endfor %}
                                        </div>
                                        {% else %}
                                        <div class="empty-state">
                                            <i class="fas fa-inbox"></i>
                                            <p>Object did not exist in customer version</p>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <!-- Vendor (C) -->
                                <div class="diff-panel">
                                    <div class="diff-panel-header package-c">
                                        <i class="fas fa-box"></i> Vendor (C)
                                    </div>
                                    <div class="diff-panel-body" style="max-height: 600px; overflow-y: auto;">
                                        {% if change.vendor_object and change.vendor_object.sail_code %}
                                        <pre class="code-block" style="margin: 0;"><code>{{ change.vendor_object.sail_code }}</code></pre>
                                        {% elif change.vendor_object %}
                                        <div class="object-properties">
                                            {% for key, value in change.vendor_object.items() %}
                                            {% if key not in ['uuid', 'sail_code'] %}
                                            <div class="property-item">
                                                <span class="property-key">{{ key }}:</span>
                                                <span class="property-value">{{ value }}</span>
                                            </div>
                                            {% endif %}
                                            {% endfor %}
                                        </div>
                                        {% else %}
                                        <div class="empty-state">
                                            <i class="fas fa-inbox"></i>
                                            <p>Object did not exist in vendor version</p>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        {% endif %}
                        
                        <!-- Vendor Changes to Incorporate -->
                        {% if change.merge_guidance and change.merge_guidance.vendor_additions %}
                        <div class="vendor-highlights">
                            <div class="highlight-header">
                                <i class="fas fa-lightbulb"></i> Vendor Changes to Incorporate
                            </div>
                            <div class="highlight-body">
                                <p>The following vendor changes should be incorporated into your customer version (B):</p>
                                <ul class="highlight-list">
                                    {% for addition in change.merge_guidance.vendor_additions %}
                                    <li class="highlight-item">
                                        <strong>{{ addition.type }}:</strong> {{ addition.description }}
                                        {% if addition.code %}
                                        <pre class="code-snippet"><code>{{ addition.code }}</code></pre>
                                        {% endif %}
                                    </li>
                                    {% endfor %}
                                </ul>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                    
                    <!-- Unified View -->
                    <div class="diff-content" id="unified">
                        <div class="unified-diff">
                            <p class="text-muted">Unified diff view - showing combined changes</p>
                            <!-- This would show a traditional unified diff format -->
                            <pre class="code-block"><code>{% if change.unified_diff %}{{ change.unified_diff }}{% else %}Unified diff not available{% endif %}</code></pre>
                        </div>
                    </div>
                    
                    <!-- Flow Diagram View (Process Models Only) -->
                    {% if change.type == 'Process Model' and change.process_model_data and change.process_model_data.has_enhanced_data %}
                    <div class="diff-content" id="flow-diagram">
                        {% include 'merge_assistant/_process_model_flow_diagram.html' %}
                    </div>
                    {% endif %}
                </div>
            </div>
        
        {% elif change.classification == 'CUSTOMER_ONLY' %}
            <!-- CUSTOMER_ONLY: Show customer changes -->
            <div class="change-section">
                <div class="section-header">
                    <h4><i class="fas fa-user-edit"></i> Customer-Only Changes</h4>
                    <p class="section-description">
                        This object was modified only by you. The vendor did not make any changes to it.
                    </p>
                </div>
                
                <div class="customer-changes-card">
                    <div class="info-banner info-banner-blue">
                        <i class="fas fa-info-circle"></i>
                        <div>
                            <strong>No Action Required</strong>
                            <p>Keep your customizations as-is. The vendor did not modify this object in the new release.</p>
                        </div>
                    </div>
                    
                    {% if change.customer_object %}
                    <div class="object-preview">
                        <h5>Your Customized Version</h5>
                        {% if change.customer_object.sail_code %}
                        <div style="max-height: 500px; overflow-y: auto; border: 1px solid #444; border-radius: 4px;">
                            <pre class="code-block" style="margin: 0;"><code>{{ change.customer_object.sail_code }}</code></pre>
                        </div>
                        {% else %}
                        <div class="object-properties">
                            {% for key, value in change.customer_object.items() %}
                            {% if key not in ['uuid', 'sail_code'] %}
                            <div class="property-item">
                                <span class="property-key">{{ key }}:</span>
                                <span class="property-value">{{ value }}</span>
                            </div>
                            {% endif %}
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
            </div>
        
        {% elif change.classification == 'REMOVED_BUT_CUSTOMIZED' %}
            <!-- REMOVED_BUT_CUSTOMIZED: Show warning -->
            <div class="change-section">
                <div class="section-header">
                    <h4><i class="fas fa-trash-restore"></i> Removed but Customized</h4>
                    <p class="section-description">
                        The vendor removed this object, but you have customizations to it.
                    </p>
                </div>
                
                <div class="removed-changes-card">
                    <div class="info-banner info-banner-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        <div>
                            <strong>Decision Required</strong>
                            <p>The vendor removed this object in the new release, but you have customizations. 
                               Consider whether to keep your customized version or remove it as the vendor did.</p>
                        </div>
                    </div>
                    
                    {% if change.customer_object %}
                    <div class="object-preview">
                        <h5>Your Customized Version</h5>
                        {% if change.customer_object.sail_code %}
                        <div style="max-height: 500px; overflow-y: auto; border: 1px solid #444; border-radius: 4px;">
                            <pre class="code-block" style="margin: 0;"><code>{{ change.customer_object.sail_code }}</code></pre>
                        </div>
                        {% else %}
                        <div class="object-properties">
                            {% for key, value in change.customer_object.items() %}
                            {% if key not in ['uuid', 'sail_code'] %}
                            <div class="property-item">
                                <span class="property-key">{{ key }}:</span>
                                <span class="property-value">{{ value }}</span>
                            </div>
                            {% endif %}
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
            </div>
        {% endif %}
        
        <!-- Merge Strategy Section -->
        {% if change.merge_guidance and change.merge_guidance.strategy %}
        <div class="change-section">
            <div class="section-header">
                <h4><i class="fas fa-lightbulb"></i> Suggested Merge Strategy</h4>
            </div>
            
            <div class="merge-strategy-card">
                <div class="strategy-badge strategy-{{ change.merge_guidance.strategy|lower|replace('_', '-') }}">
                    {{ change.merge_guidance.strategy|replace('_', ' ')|title }}
                </div>
                
                {% if change.merge_guidance.recommendations %}
                <div class="recommendations-list">
                    <h5>Recommendations:</h5>
                    <ol>
                        {% for recommendation in change.merge_guidance.recommendations %}
                        <li>{{ recommendation }}</li>
                        {% endfor %}
                    </ol>
                </div>
                {% endif %}
                
                {% if change.merge_guidance.conflict_sections %}
                <div class="conflict-sections">
                    <h5><i class="fas fa-code-branch"></i> Conflicting Sections:</h5>
                    <p class="text-muted">These sections were modified by both you and the vendor:</p>
                    {% for section in change.merge_guidance.conflict_sections %}
                    <div class="conflict-section-item">
                        <div class="conflict-section-header">
                            <span class="section-name">{{ section.name }}</span>
                            <span class="section-location">{{ section.location }}</span>
                        </div>
                        {% if section.description %}
                        <p class="section-description">{{ section.description }}</p>
                        {% endif %}
                        {% if section.resolution_hint %}
                        <div class="resolution-hint">
                            <i class="fas fa-info-circle"></i> {{ section.resolution_hint }}
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}
        
        <!-- User Notes Section -->
        <div class="change-section">
            <div class="section-header">
                <h4><i class="fas fa-sticky-note"></i> Notes</h4>
            </div>
            
            <div class="notes-card">
                <textarea id="userNotes" class="form-control notes-textarea" 
                          placeholder="Add your notes about this change, merge decisions, or any concerns..."
                          rows="4">{{ change.user_notes if change.user_notes else '' }}</textarea>
            </div>
        </div>
    </div>
    
    <!-- Right Column: Sidebar -->
    <div class="col-lg-3">
        <!-- Dependencies Card -->
        {% if change.dependencies %}
        <div class="sidebar-card">
            <div class="sidebar-header">
                <h5><i class="fas fa-sitemap"></i> Dependencies</h5>
            </div>
            
            <div class="sidebar-body">
                {% if change.dependencies.parents %}
                <div class="dependency-section">
                    <h6>Depends On (Parents)</h6>
                    <div class="dependency-list">
                        {% for parent in change.dependencies.parents %}
                        <div class="dependency-item">
                            <div class="dependency-icon">
                                <i class="fas fa-arrow-up"></i>
                            </div>
                            <div class="dependency-info">
                                <div class="dependency-name">{{ parent.name }}</div>
                                <div class="dependency-status status-{{ parent.review_status }}">
                                    {% if parent.review_status == 'reviewed' %}
                                        <i class="fas fa-check-circle"></i> Reviewed
                                    {% elif parent.review_status == 'skipped' %}
                                        <i class="fas fa-forward"></i> Skipped
                                    {% else %}
                                        <i class="fas fa-clock"></i> Pending
                                    {% endif %}
                                </div>
                            </div>
                            {% if parent.in_change_list %}
                            <a href="{{ url_for('merge_assistant.view_change', session_id=session.id, change_index=parent.change_index) }}" 
                               class="dependency-link" title="Jump to this change">
                                <i class="fas fa-external-link-alt"></i>
                            </a>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
                
                {% if change.dependencies.children %}
                <div class="dependency-section">
                    <h6>Used By (Children)</h6>
                    <div class="dependency-list">
                        {% for child in change.dependencies.children %}
                        <div class="dependency-item">
                            <div class="dependency-icon">
                                <i class="fas fa-arrow-down"></i>
                            </div>
                            <div class="dependency-info">
                                <div class="dependency-name">{{ child.name }}</div>
                                <div class="dependency-status status-{{ child.review_status }}">
                                    {% if child.review_status == 'reviewed' %}
                                        <i class="fas fa-check-circle"></i> Reviewed
                                    {% elif child.review_status == 'skipped' %}
                                        <i class="fas fa-forward"></i> Skipped
                                    {% else %}
                                        <i class="fas fa-clock"></i> Pending
                                    {% endif %}
                                </div>
                            </div>
                            {% if child.in_change_list %}
                            <a href="{{ url_for('merge_assistant.view_change', session_id=session.id, change_index=child.change_index) }}" 
                               class="dependency-link" title="Jump to this change">
                                <i class="fas fa-external-link-alt"></i>
                            </a>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
                
                {% if not change.dependencies.parents and not change.dependencies.children %}
                <div class="empty-state-small">
                    <i class="fas fa-inbox"></i>
                    <p>No dependencies found</p>
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}
        
        <!-- Quick Actions Card -->
        <div class="sidebar-card">
            <div class="sidebar-header">
                <h5><i class="fas fa-bolt"></i> Quick Actions</h5>
            </div>
            
            <div class="sidebar-body">
                <button class="btn btn-success btn-block mb-2" id="markReviewedBtn">
                    <i class="fas fa-check-circle"></i> Mark as Reviewed
                </button>
                <button class="btn btn-warning btn-block mb-2" id="skipBtn">
                    <i class="fas fa-forward"></i> Skip
                </button>
                <button class="btn btn-outline-secondary btn-block" id="saveNotesBtn">
                    <i class="fas fa-save"></i> Save Notes
                </button>
            </div>
        </div>
        
        <!-- Session Info Card -->
        <div class="sidebar-card">
            <div class="sidebar-header">
                <h5><i class="fas fa-info-circle"></i> Session Info</h5>
            </div>
            
            <div class="sidebar-body">
                <div class="info-item">
                    <span class="info-label">Session ID:</span>
                    <span class="info-value">{{ session.reference_id }}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Status:</span>
                    <span class="info-value">{{ session.status|title }}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Reviewed:</span>
                    <span class="info-value">{{ session.reviewed_count }}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Skipped:</span>
                    <span class="info-value">{{ session.skipped_count }}</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Navigation Footer -->
<div class="row mt-4">
    <div class="col-12">
        <div class="navigation-card">
            <div class="nav-buttons-left">
                {% if has_previous %}
                <a href="{{ url_for('merge_assistant.view_change', session_id=session.id, change_index=change_index-1) }}" 
                   class="btn btn-outline-primary">
                    <i class="fas fa-arrow-left"></i> Previous
                </a>
                {% else %}
                <button class="btn btn-outline-secondary" disabled>
                    <i class="fas fa-arrow-left"></i> Previous
                </button>
                {% endif %}
                
                <a href="{{ url_for('merge_assistant.view_summary', session_id=session.id) }}" 
                   class="btn btn-outline-secondary">
                    <i class="fas fa-th-large"></i> Back to Summary
                </a>
            </div>
            
            <div class="nav-buttons-right">
                {% if is_last %}
                <a href="{{ url_for('merge_assistant.generate_report', session_id=session.id) }}" 
                   class="btn btn-primary">
                    <i class="fas fa-flag-checkered"></i> Complete Review
                </a>
                {% elif has_next %}
                <a href="{{ url_for('merge_assistant.view_change', session_id=session.id, change_index=change_index+1) }}" 
                   class="btn btn-primary" id="nextBtn">
                    Next <i class="fas fa-arrow-right"></i>
                </a>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<style>
/* Fix horizontal overflow */
body, html {
    overflow-x: hidden;
    max-width: 100%;
}

.main-content {
    max-width: 100%;
    overflow-x: hidden;
}

/* Progress Card */
.progress-card {
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 1.5rem;
}

.progress-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
}

.progress-info {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.progress-label {
    font-size: 0.875rem;
    color: var(--text-secondary);
    font-weight: 600;
}

.progress-count {
    font-size: 1.125rem;
    color: var(--text-primary);
    font-weight: 700;
}

.progress-percentage {
    font-size: 1.5rem;
    color: var(--purple);
    font-weight: 700;
}

.progress-bar-container {
    height: 12px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 6px;
    overflow: hidden;
}

.progress-bar-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--purple), var(--teal));
    border-radius: 6px;
    transition: width 0.3s ease;
}

/* Object Header */
.object-header-card {
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 2rem;
    display: flex;
    align-items: center;
    gap: 1.5rem;
    max-width: 100%;
    overflow: hidden;
}

.object-icon-wrapper {
    flex-shrink: 0;
}

.object-icon {
    width: 70px;
    height: 70px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2rem;
    color: white;
}

.object-icon.classification-no_conflict {
    background: linear-gradient(135deg, #10b981, #059669);
}

.object-icon.classification-conflict {
    background: linear-gradient(135deg, #ef4444, #dc2626);
}

.object-icon.classification-customer_only {
    background: linear-gradient(135deg, #3b82f6, #2563eb);
}

.object-icon.classification-removed_but_customized {
    background: linear-gradient(135deg, #f59e0b, #d97706);
}

.object-details {
    flex: 1;
}

.object-details h2 {
    margin: 0 0 0.75rem 0;
    color: var(--text-primary);
    font-size: 1.5rem;
    font-weight: 600;
    word-break: break-word;
    overflow-wrap: break-word;
}

.object-meta {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
}

.object-meta span {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    border-radius: 8px;
    font-size: 0.875rem;
    font-weight: 600;
}

.object-type {
    background: rgba(139, 92, 246, 0.2);
    color: var(--purple);
}

.object-classification {
    border: 2px solid;
}

.object-classification.classification-no_conflict {
    background: rgba(16, 185, 129, 0.1);
    border-color: var(--green);
    color: var(--green);
}

.object-classification.classification-conflict {
    background: rgba(239, 68, 68, 0.1);
    border-color: #ef4444;
    color: #ef4444;
}

.object-classification.classification-customer_only {
    background: rgba(59, 130, 246, 0.1);
    border-color: #3b82f6;
    color: #3b82f6;
}

.object-classification.classification-removed_but_customized {
    background: rgba(245, 158, 11, 0.1);
    border-color: #f59e0b;
    color: #f59e0b;
}

.review-status {
    background: rgba(156, 163, 175, 0.2);
    color: #9ca3af;
}

.review-status.status-reviewed {
    background: rgba(16, 185, 129, 0.2);
    color: var(--green);
}

.review-status.status-skipped {
    background: rgba(251, 191, 36, 0.2);
    color: #fbbf24;
}

.jump-to-change {
    flex-shrink: 0;
}

/* Change Sections */
.change-section {
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 2rem;
    margin-bottom: 1.5rem;
}

.section-header {
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid var(--border-color);
}

.section-header h4 {
    margin: 0 0 0.5rem 0;
    color: var(--text-primary);
    font-size: 1.25rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.section-description {
    margin: 0;
    color: var(--text-secondary);
    font-size: 0.875rem;
}

/* Info Banners */
.info-banner {
    display: flex;
    align-items: flex-start;
    gap: 1rem;
    padding: 1rem;
    border-radius: 8px;
    margin-bottom: 1.5rem;
}

.info-banner-blue {
    background: rgba(59, 130, 246, 0.1);
    border: 1px solid rgba(59, 130, 246, 0.3);
    color: #60a5fa;
}

.info-banner-warning {
    background: rgba(245, 158, 11, 0.1);
    border: 1px solid rgba(245, 158, 11, 0.3);
    color: #fbbf24;
}

.info-banner i {
    font-size: 1.5rem;
    flex-shrink: 0;
}

.info-banner strong {
    display: block;
    margin-bottom: 0.25rem;
    color: var(--text-primary);
}

.info-banner p {
    margin: 0;
    font-size: 0.875rem;
}

/* Three-Way Diff */
.three-way-diff-card {
    background: rgba(139, 92, 246, 0.03);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    overflow: hidden;
}

.diff-tabs {
    display: flex;
    border-bottom: 1px solid var(--border-color);
    background: rgba(0, 0, 0, 0.2);
}

.diff-tab {
    flex: 1;
    padding: 1rem;
    background: transparent;
    border: none;
    border-bottom: 3px solid transparent;
    color: var(--text-secondary);
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
}

.diff-tab:hover {
    background: rgba(139, 92, 246, 0.1);
    color: var(--text-primary);
}

.diff-tab.active {
    color: var(--purple);
    border-bottom-color: var(--purple);
    background: rgba(139, 92, 246, 0.15);
}

.diff-content {
    display: none;
    padding: 1.5rem;
}

.diff-content.active {
    display: block;
}

.three-way-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 1rem;
    margin-bottom: 1.5rem;
}

.diff-panel {
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    overflow: hidden;
}

.diff-panel-header {
    padding: 0.75rem 1rem;
    font-weight: 600;
    font-size: 0.875rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: white;
}

.diff-panel-header.package-a {
    background: linear-gradient(135deg, #ef4444, #dc2626);
}

.diff-panel-header.package-b {
    background: linear-gradient(135deg, #3b82f6, #2563eb);
}

.diff-panel-header.package-c {
    background: linear-gradient(135deg, #10b981, #059669);
}

.diff-panel-body {
    padding: 1rem;
    max-height: 600px;
    overflow-y: auto;
}

.code-block {
    background: rgba(0, 0, 0, 0.3);
    border: 1px solid var(--border-color);
    border-radius: 6px;
    padding: 1rem;
    margin: 0;
    overflow-x: auto;
    font-family: 'Courier New', monospace;
    font-size: 0.875rem;
    line-height: 1.5;
    color: var(--text-primary);
}

.code-block code {
    color: var(--text-primary);
}

.object-properties {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.property-item {
    display: flex;
    gap: 0.5rem;
    padding: 0.5rem;
    background: rgba(139, 92, 246, 0.05);
    border-radius: 4px;
}

.property-key {
    font-weight: 600;
    color: var(--purple);
    min-width: 100px;
}

.property-value {
    color: var(--text-primary);
    word-break: break-word;
}

.empty-state {
    text-align: center;
    padding: 3rem 1rem;
    color: var(--text-secondary);
}

.empty-state i {
    font-size: 3rem;
    margin-bottom: 1rem;
    opacity: 0.5;
}

.empty-state p {
    margin: 0;
    font-size: 0.875rem;
}

/* Vendor Highlights */
.vendor-highlights {
    background: rgba(16, 185, 129, 0.05);
    border: 1px solid rgba(16, 185, 129, 0.3);
    border-radius: 8px;
    padding: 1.5rem;
}

.highlight-header {
    font-weight: 600;
    color: var(--green);
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 1rem;
}

.highlight-body p {
    color: var(--text-secondary);
    font-size: 0.875rem;
    margin-bottom: 1rem;
}

.highlight-list {
    list-style: none;
    padding: 0;
    margin: 0;
}

.highlight-item {
    padding: 1rem;
    background: rgba(16, 185, 129, 0.1);
    border-radius: 6px;
    margin-bottom: 0.75rem;
    color: var(--text-primary);
}

.highlight-item strong {
    color: var(--green);
}

.code-snippet {
    background: rgba(0, 0, 0, 0.3);
    border: 1px solid var(--border-color);
    border-radius: 4px;
    padding: 0.75rem;
    margin-top: 0.5rem;
    font-family: 'Courier New', monospace;
    font-size: 0.8125rem;
    overflow-x: auto;
}

/* Guidance Sections */
.vendor-changes-card,
.customer-changes-card,
.removed-changes-card {
    margin-top: 1rem;
}

.guidance-section {
    margin-bottom: 2rem;
}

.guidance-section:last-child {
    margin-bottom: 0;
}

.guidance-section h5 {
    margin: 0 0 0.75rem 0;
    color: var(--text-primary);
    font-size: 1.125rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.guidance-description {
    color: var(--text-secondary);
    font-size: 0.875rem;
    margin-bottom: 1rem;
}

.additions-list,
.modifications-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.addition-item,
.modification-item {
    background: rgba(139, 92, 246, 0.05);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 1rem;
}

.addition-header,
.modification-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.75rem;
}

.addition-type,
.modification-type {
    font-weight: 600;
    color: var(--purple);
    font-size: 0.875rem;
}

.addition-location {
    font-size: 0.75rem;
    color: var(--text-secondary);
}

.addition-description,
.modification-description {
    color: var(--text-secondary);
    font-size: 0.875rem;
    margin-top: 0.75rem;
}

.diff-view {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
    margin-top: 0.75rem;
}

.diff-column {
    background: rgba(0, 0, 0, 0.2);
    border: 1px solid var(--border-color);
    border-radius: 6px;
    overflow: hidden;
}

.diff-label {
    padding: 0.5rem 1rem;
    background: rgba(139, 92, 246, 0.2);
    color: var(--purple);
    font-weight: 600;
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.object-preview {
    margin-top: 1.5rem;
}

.object-preview h5 {
    margin: 0 0 1rem 0;
    color: var(--text-primary);
    font-size: 1rem;
    font-weight: 600;
}

/* Merge Strategy */
.merge-strategy-card {
    background: rgba(139, 92, 246, 0.05);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 1.5rem;
}

.strategy-badge {
    display: inline-block;
    padding: 0.5rem 1rem;
    border-radius: 8px;
    font-weight: 600;
    font-size: 0.875rem;
    margin-bottom: 1.5rem;
}

.strategy-badge.strategy-incorporate-vendor-additions {
    background: rgba(16, 185, 129, 0.2);
    color: var(--green);
}

.strategy-badge.strategy-manual-merge-required {
    background: rgba(239, 68, 68, 0.2);
    color: #ef4444;
}

.strategy-badge.strategy-keep-customer-version {
    background: rgba(59, 130, 246, 0.2);
    color: #3b82f6;
}

.strategy-badge.strategy-evaluate-removal {
    background: rgba(245, 158, 11, 0.2);
    color: #f59e0b;
}

.recommendations-list {
    margin-bottom: 1.5rem;
}

.recommendations-list h5 {
    margin: 0 0 0.75rem 0;
    color: var(--text-primary);
    font-size: 1rem;
    font-weight: 600;
}

.recommendations-list ol {
    margin: 0;
    padding-left: 1.5rem;
    color: var(--text-primary);
}

.recommendations-list li {
    margin-bottom: 0.5rem;
    line-height: 1.6;
}

.conflict-sections {
    margin-top: 1.5rem;
}

.conflict-sections h5 {
    margin: 0 0 0.5rem 0;
    color: var(--text-primary);
    font-size: 1rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.conflict-sections > p {
    color: var(--text-secondary);
    font-size: 0.875rem;
    margin-bottom: 1rem;
}

.conflict-section-item {
    background: rgba(239, 68, 68, 0.05);
    border: 1px solid rgba(239, 68, 68, 0.3);
    border-radius: 6px;
    padding: 1rem;
    margin-bottom: 0.75rem;
}

.conflict-section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
}

.section-name {
    font-weight: 600;
    color: var(--text-primary);
}

.section-location {
    font-size: 0.75rem;
    color: var(--text-secondary);
}

.section-description {
    color: var(--text-secondary);
    font-size: 0.875rem;
    margin: 0.5rem 0;
}

.resolution-hint {
    background: rgba(59, 130, 246, 0.1);
    border-left: 3px solid #3b82f6;
    padding: 0.75rem;
    margin-top: 0.75rem;
    border-radius: 4px;
    color: #60a5fa;
    font-size: 0.875rem;
    display: flex;
    align-items: flex-start;
    gap: 0.5rem;
}

.resolution-hint i {
    flex-shrink: 0;
    margin-top: 0.125rem;
}

/* Notes */
.notes-card {
    background: rgba(139, 92, 246, 0.03);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 1rem;
}

.notes-textarea {
    background: rgba(0, 0, 0, 0.2);
    border: 1px solid var(--border-color);
    color: var(--text-primary);
    border-radius: 6px;
    padding: 0.75rem;
    font-size: 0.875rem;
    resize: vertical;
    width: 100%;
}

.notes-textarea:focus {
    outline: none;
    border-color: var(--purple);
    box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
}

.notes-textarea::placeholder {
    color: var(--text-secondary);
    opacity: 0.6;
}

/* Sidebar */
.sidebar-card {
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    overflow: hidden;
    margin-bottom: 1.5rem;
}

.sidebar-header {
    padding: 1rem 1.5rem;
    background: rgba(139, 92, 246, 0.1);
    border-bottom: 1px solid var(--border-color);
}

.sidebar-header h5 {
    margin: 0;
    color: var(--text-primary);
    font-size: 1rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.sidebar-body {
    padding: 1.5rem;
}

/* Dependencies */
.dependency-section {
    margin-bottom: 1.5rem;
}

.dependency-section:last-child {
    margin-bottom: 0;
}

.dependency-section h6 {
    margin: 0 0 0.75rem 0;
    color: var(--text-secondary);
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.dependency-list {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}

.dependency-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem;
    background: rgba(139, 92, 246, 0.05);
    border: 1px solid var(--border-color);
    border-radius: 6px;
    transition: all 0.2s;
}

.dependency-item:hover {
    background: rgba(139, 92, 246, 0.1);
    transform: translateX(2px);
}

.dependency-icon {
    width: 32px;
    height: 32px;
    background: rgba(139, 92, 246, 0.2);
    color: var(--purple);
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.875rem;
    flex-shrink: 0;
}

.dependency-info {
    flex: 1;
    min-width: 0;
}

.dependency-name {
    font-weight: 600;
    color: var(--text-primary);
    font-size: 0.875rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.dependency-status {
    font-size: 0.75rem;
    display: flex;
    align-items: center;
    gap: 0.25rem;
    margin-top: 0.25rem;
}

.dependency-status.status-reviewed {
    color: var(--green);
}

.dependency-status.status-skipped {
    color: #fbbf24;
}

.dependency-status.status-pending {
    color: var(--text-secondary);
}

.dependency-link {
    color: var(--purple);
    font-size: 0.875rem;
    flex-shrink: 0;
    transition: all 0.2s;
}

.dependency-link:hover {
    color: var(--teal);
    transform: scale(1.1);
}

.empty-state-small {
    text-align: center;
    padding: 2rem 1rem;
    color: var(--text-secondary);
}

.empty-state-small i {
    font-size: 2rem;
    margin-bottom: 0.5rem;
    opacity: 0.5;
}

.empty-state-small p {
    margin: 0;
    font-size: 0.75rem;
}

/* Quick Actions */
.btn-block {
    width: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    padding: 0.75rem;
    font-weight: 600;
    border-radius: 8px;
    transition: all 0.2s;
}

.btn-success {
    background: linear-gradient(135deg, #10b981, #059669);
    border: none;
    color: white;
}

.btn-success:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
}

.btn-warning {
    background: linear-gradient(135deg, #f59e0b, #d97706);
    border: none;
    color: white;
}

.btn-warning:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(245, 158, 11, 0.4);
}

/* Session Info */
.info-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.5rem 0;
    border-bottom: 1px solid var(--border-color);
}

.info-item:last-child {
    border-bottom: none;
}

.info-label {
    font-size: 0.875rem;
    color: var(--text-secondary);
    font-weight: 600;
}

.info-value {
    font-size: 0.875rem;
    color: var(--text-primary);
    font-weight: 600;
}

/* Navigation Footer */
.navigation-card {
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 1.5rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 1rem;
}

.nav-buttons-left,
.nav-buttons-right {
    display: flex;
    gap: 0.75rem;
}

.btn {
    padding: 0.75rem 1.5rem;
    border-radius: 8px;
    font-weight: 600;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    transition: all 0.2s;
    text-decoration: none;
}

.btn-primary {
    background: linear-gradient(135deg, var(--purple), var(--teal));
    border: none;
    color: white;
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4);
    color: white;
}

.btn-outline-primary {
    background: transparent;
    border: 2px solid var(--purple);
    color: var(--purple);
}

.btn-outline-primary:hover {
    background: rgba(139, 92, 246, 0.1);
    color: var(--purple);
}

.btn-outline-secondary {
    background: transparent;
    border: 2px solid var(--border-color);
    color: var(--text-primary);
}

.btn-outline-secondary:hover {
    background: rgba(139, 92, 246, 0.1);
    border-color: var(--purple);
    color: var(--purple);
}

.btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.btn:disabled:hover {
    transform: none;
    box-shadow: none;
}

/* Responsive */
@media (max-width: 992px) {
    .three-way-grid {
        grid-template-columns: 1fr;
    }
    
    .diff-view {
        grid-template-columns: 1fr;
    }
    
    .navigation-card {
        flex-direction: column;
    }
    
    .nav-buttons-left,
    .nav-buttons-right {
        width: 100%;
        justify-content: center;
    }
    
    .object-header-card {
        flex-direction: column;
        text-align: center;
    }
}
</style>
{% endblock %}

{% block scripts %}
<!-- Mermaid.js for flow diagrams -->
<script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
<script>
// Initialize Mermaid
mermaid.initialize({ 
    startOnLoad: true,
    theme: 'dark',
    themeVariables: {
        primaryColor: '#8b5cf6',
        primaryTextColor: '#fff',
        primaryBorderColor: '#6d28d9',
        lineColor: '#a78bfa',
        secondaryColor: '#14b8a6',
        tertiaryColor: '#10b981'
    }
});
</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const sessionId = {{ session.id }};
    const changeIndex = {{ change_index }};
    const isLast = {{ 'true' if is_last else 'false' }};
    
    // Diff tab switching
    const diffTabs = document.querySelectorAll('.diff-tab');
    const diffContents = document.querySelectorAll('.diff-content');
    
    diffTabs.forEach(tab => {
        tab.addEventListener('click', function() {
            const targetTab = this.dataset.tab;
            
            // Update active tab
            diffTabs.forEach(t => t.classList.remove('active'));
            this.classList.add('active');
            
            // Update active content
            diffContents.forEach(content => {
                content.classList.remove('active');
                if (content.id === targetTab) {
                    content.classList.add('active');
                }
            });
        });
    });
    
    // Mark as Reviewed button
    const markReviewedBtn = document.getElementById('markReviewedBtn');
    if (markReviewedBtn) {
        markReviewedBtn.addEventListener('click', async function() {
            await handleReviewAction('reviewed');
        });
    }
    
    // Skip button
    const skipBtn = document.getElementById('skipBtn');
    if (skipBtn) {
        skipBtn.addEventListener('click', async function() {
            await handleReviewAction('skipped');
        });
    }
    
    // Save Notes button
    const saveNotesBtn = document.getElementById('saveNotesBtn');
    if (saveNotesBtn) {
        saveNotesBtn.addEventListener('click', async function() {
            const notes = document.getElementById('userNotes').value;
            await saveNotes(notes);
        });
    }
    
    async function handleReviewAction(action) {
        const notes = document.getElementById('userNotes').value;
        
        try {
            // Disable buttons
            markReviewedBtn.disabled = true;
            skipBtn.disabled = true;
            
            const response = await fetch(
                `/merge-assistant/session/${sessionId}/change/${changeIndex}/review`,
                {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: action,
                        notes: notes
                    })
                }
            );
            
            if (response.ok) {
                const result = await response.json();
                
                // Show success message
                showNotification(
                    action === 'reviewed' ? 'Change marked as reviewed' : 'Change skipped',
                    'success'
                );
                
                // Navigate to next change or report
                if (result.is_complete) {
                    // Redirect to report
                    window.location.href = `/merge-assistant/session/${sessionId}/report`;
                } else {
                    // Redirect to next change
                    window.location.href = `/merge-assistant/session/${sessionId}/change/${result.next_index}`;
                }
            } else {
                const error = await response.json();
                showNotification(error.error || 'Failed to record review', 'error');
                
                // Re-enable buttons
                markReviewedBtn.disabled = false;
                skipBtn.disabled = false;
            }
        } catch (error) {
            showNotification('Network error: ' + error.message, 'error');
            
            // Re-enable buttons
            markReviewedBtn.disabled = false;
            skipBtn.disabled = false;
        }
    }
    
    async function saveNotes(notes) {
        try {
            saveNotesBtn.disabled = true;
            saveNotesBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
            
            const response = await fetch(
                `/merge-assistant/session/${sessionId}/change/${changeIndex}/review`,
                {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: '{{ change.review_status if change.review_status != "pending" else "reviewed" }}',
                        notes: notes
                    })
                }
            );
            
            if (response.ok) {
                showNotification('Notes saved successfully', 'success');
            } else {
                const error = await response.json();
                showNotification(error.error || 'Failed to save notes', 'error');
            }
        } catch (error) {
            showNotification('Network error: ' + error.message, 'error');
        } finally {
            saveNotesBtn.disabled = false;
            saveNotesBtn.innerHTML = '<i class="fas fa-save"></i> Save Notes';
        }
    }
    
    function showNotification(message, type) {
        // Create notification element
        const notification = document.createElement('div');
        notification.className = `notification notification-${type}`;
        notification.innerHTML = `
            <div class="notification-content">
                <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
                <span>${message}</span>
            </div>
        `;
        
        // Add to page
        document.body.appendChild(notification);
        
        // Show notification
        setTimeout(() => {
            notification.classList.add('show');
        }, 100);
        
        // Remove after 3 seconds
        setTimeout(() => {
            notification.classList.remove('show');
            setTimeout(() => {
                notification.remove();
            }, 300);
        }, 3000);
    }
    
    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        // Ctrl/Cmd + Enter: Mark as reviewed
        if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
            e.preventDefault();
            markReviewedBtn.click();
        }
        
        // Ctrl/Cmd + S: Save notes
        if ((e.ctrlKey || e.metaKey) && e.key === 's') {
            e.preventDefault();
            saveNotesBtn.click();
        }
        
        // Ctrl/Cmd + Right Arrow: Next change
        if ((e.ctrlKey || e.metaKey) && e.key === 'ArrowRight') {
            e.preventDefault();
            const nextBtn = document.getElementById('nextBtn');
            if (nextBtn) {
                nextBtn.click();
            }
        }
        
        // Ctrl/Cmd + Left Arrow: Previous change
        if ((e.ctrlKey || e.metaKey) && e.key === 'ArrowLeft') {
            e.preventDefault();
            const prevBtn = document.querySelector('.btn-outline-primary');
            if (prevBtn && !prevBtn.disabled) {
                prevBtn.click();
            }
        }
    });
});
</script>

<style>
/* Notification styles */
.notification {
    position: fixed;
    top: 20px;
    right: 20px;
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 1rem 1.5rem;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    z-index: 9999;
    opacity: 0;
    transform: translateX(100px);
    transition: all 0.3s ease;
}

.notification.show {
    opacity: 1;
    transform: translateX(0);
}

.notification-content {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    color: var(--text-primary);
    font-weight: 600;
}

.notification-success {
    border-left: 4px solid var(--green);
}

.notification-success i {
    color: var(--green);
}

.notification-error {
    border-left: 4px solid #ef4444;
}

.notification-error i {
    color: #ef4444;
}
</style>

<!-- Mermaid JS for Flow Diagrams -->
<script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
<script>
    // Initialize Mermaid with dark theme
    mermaid.initialize({
        startOnLoad: false,
        theme: 'dark',
        themeVariables: {
            primaryColor: '#3b82f6',
            primaryTextColor: '#fff',
            primaryBorderColor: '#2563eb',
            lineColor: '#6b7280',
            secondaryColor: '#10b981',
            tertiaryColor: '#f59e0b',
            background: '#1a1a1a',
            mainBkg: '#1a1a1a',
            secondBkg: '#2a2a2a',
            tertiaryBkg: '#3a3a3a',
            textColor: '#e5e7eb',
            border1: '#374151',
            border2: '#4b5563'
        },
        flowchart: {
            useMaxWidth: true,
            htmlLabels: true,
            curve: 'basis'
        }
    });
    
    // Function to manually render mermaid diagram
    async function renderFlowDiagram() {
        const mermaidDiv = document.getElementById('process-flow-diagram');
        if (!mermaidDiv || mermaidDiv.getAttribute('data-rendered') === 'true') {
            return;
        }
        
        try {
            // Fetch the page source to get the original Mermaid code
            const response = await fetch(window.location.href);
            const html = await response.text();
            const match = html.match(/<div class="mermaid"[^>]*id="process-flow-diagram">([\s\S]*?)<\/div>/);
            
            if (match) {
                const mermaidCode = match[1].trim();
                
                if (mermaidCode && mermaidCode.startsWith('graph')) {
                    // Render using mermaid.render() which works better than run()
                    const { svg } = await mermaid.render('process-flow-diagram-rendered', mermaidCode);
                    mermaidDiv.innerHTML = svg;
                    mermaidDiv.setAttribute('data-rendered', 'true');
                }
            }
        } catch (e) {
            console.error('Failed to render Mermaid diagram:', e);
        }
    }
    
    // Render mermaid diagrams when DOM is ready
    document.addEventListener('DOMContentLoaded', function() {
        // Re-render when tab is switched to flow diagram
        const flowDiagramTab = document.querySelector('[data-tab="flow-diagram"]');
        if (flowDiagramTab) {
            flowDiagramTab.addEventListener('click', function() {
                setTimeout(() => {
                    renderFlowDiagram();
                }, 100);
            });
        }
        
        // Check if flow diagram tab is already active on page load
        const flowDiagramContent = document.getElementById('flow-diagram');
        if (flowDiagramContent && flowDiagramContent.classList.contains('active')) {
            renderFlowDiagram();
        }
    });
</script>
{% endblock %}

</content>
</file>