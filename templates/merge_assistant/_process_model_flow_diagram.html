{# Process Model Flow Diagram with Change Highlighting #}
{# Requirements: 7.5, 7.6, 7.7, 7.9, 7.10 #}

{# Macro to generate Mermaid diagram with change highlighting - MUST BE DEFINED FIRST #}
{% macro _generate_comparison_diagram(pm_data) -%}
graph TD
{%- if pm_data.node_comparison -%}
{%- set node_status = {} -%}
{%- for node in pm_data.node_comparison.get('added', []) -%}
{%- set _ = node_status.update({node.get('uuid'): 'added'}) -%}
{%- endfor -%}
{%- for node in pm_data.node_comparison.get('removed', []) -%}
{%- set _ = node_status.update({node.get('uuid'): 'removed'}) -%}
{%- endfor -%}
{%- for mod in pm_data.node_comparison.get('modified', []) -%}
{%- set _ = node_status.update({mod.get('node', {}).get('uuid'): 'modified'}) -%}
{%- endfor -%}
{%- for node in pm_data.node_comparison.get('unchanged', []) -%}
{%- set _ = node_status.update({node.get('uuid'): 'unchanged'}) -%}
{%- endfor -%}
{%- set modified_nodes = [] -%}
{%- for mod in pm_data.node_comparison.get('modified', []) -%}
{%- set _ = modified_nodes.append(mod.get('node', {})) -%}
{%- endfor -%}
{%- for status, nodes in [
    ('added', pm_data.node_comparison.get('added', [])),
    ('removed', pm_data.node_comparison.get('removed', [])),
    ('modified', modified_nodes),
    ('unchanged', pm_data.node_comparison.get('unchanged', []))
] -%}
{%- for node in nodes -%}
{%- set node_id = node.get('uuid', '')|replace('-', '_')|replace('.', '_') -%}
{%- set node_label = node.get('name', 'Unknown')|replace('"', "'") -%}
{%- if node.get('type') == 'USER_INPUT_TASK' %}
    {{ node_id }}["{{ node_label }}"]
{%- elif node.get('type') == 'GATEWAY' %}
    {{ node_id }}{"{{ node_label }}"}
{%- elif node.get('type') == 'SCRIPT_TASK' %}
    {{ node_id }}("{{ node_label }}")
{%- elif node.get('type') == 'START_NODE' %}
    {{ node_id }}(("{{ node_label }}"))
{%- elif node.get('type') == 'END_NODE' %}
    {{ node_id }}(("{{ node_label }}"))
{%- else %}
    {{ node_id }}["{{ node_label }}"]
{%- endif -%}
{%- if status == 'added' %}
    style {{ node_id }} fill:#10b981,stroke:#059669,stroke-width:3px,color:#fff
{%- elif status == 'removed' %}
    style {{ node_id }} fill:#ef4444,stroke:#dc2626,stroke-width:3px,color:#fff
{%- elif status == 'modified' %}
    style {{ node_id }} fill:#f59e0b,stroke:#d97706,stroke-width:3px,color:#fff
{%- else %}
    style {{ node_id }} fill:#3b82f6,stroke:#2563eb,stroke-width:2px,color:#fff
{%- endif -%}
{%- endfor -%}
{%- endfor -%}
{# Now render flows - check if flow_comparison has data, otherwise use flow_graph #}
{%- set has_flow_comparison_data = pm_data.flow_comparison and (pm_data.flow_comparison.get('added_flows', []) or pm_data.flow_comparison.get('unchanged_flows', [])) -%}
{%- if has_flow_comparison_data -%}
{# Use flow_comparison data (added and unchanged flows) #}
{%- for flow in pm_data.flow_comparison.get('added_flows', []) -%}
{%- set from_id = flow.get('from_node_uuid', '')|replace('-', '_')|replace('.', '_') -%}
{%- set to_id = flow.get('to_node_uuid', '')|replace('-', '_')|replace('.', '_') -%}
{%- if flow.get('condition') -%}
{%- set condition_label = flow.get('condition', '')[:30]|replace('"', "'") %}
    {{ from_id }} -.->|"{{ condition_label }}..."| {{ to_id }}
{%- else %}
    {{ from_id }} -.-> {{ to_id }}
{%- endif %}
    linkStyle {{ loop.index0 }} stroke:#10b981,stroke-width:3px
{%- endfor -%}
{%- for flow in pm_data.flow_comparison.get('unchanged_flows', []) -%}
{%- set from_id = flow.get('from_node_uuid', '')|replace('-', '_')|replace('.', '_') -%}
{%- set to_id = flow.get('to_node_uuid', '')|replace('-', '_')|replace('.', '_') -%}
{%- if flow.get('condition') -%}
{%- set condition_label = flow.get('condition', '')[:30]|replace('"', "'") %}
    {{ from_id }} -->|"{{ condition_label }}..."| {{ to_id }}
{%- else %}
    {{ from_id }} --> {{ to_id }}
{%- endif -%}
{%- endfor -%}
{%- elif pm_data.get('flow_graph') and pm_data.get('flow_graph', {}).get('flows') -%}
{# Fallback: Use flow_graph.flows if flow_comparison is empty #}
{%- for flow in pm_data.get('flow_graph', {}).get('flows', []) -%}
{%- set from_id = flow.get('from_node_uuid', '')|replace('-', '_')|replace('.', '_') -%}
{%- set to_id = flow.get('to_node_uuid', '')|replace('-', '_')|replace('.', '_') -%}
{%- if flow.get('condition') -%}
{%- set condition_label = flow.get('condition', '')[:30]|replace('"', "'") %}
    {{ from_id }} -->|"{{ condition_label }}..."| {{ to_id }}
{%- else %}
    {{ from_id }} --> {{ to_id }}
{%- endif -%}
{%- endfor -%}
{%- endif -%}
{%- else -%}
{# No node_comparison - use flow_graph.flows directly #}
{%- if pm_data.get('flow_graph') and pm_data.get('flow_graph', {}).get('flows') -%}
{%- for flow in pm_data.get('flow_graph', {}).get('flows', []) -%}
{%- set from_id = flow.get('from_node_uuid', '')|replace('-', '_')|replace('.', '_') -%}
{%- set to_id = flow.get('to_node_uuid', '')|replace('-', '_')|replace('.', '_') -%}
{%- if flow.get('condition') -%}
{%- set condition_label = flow.get('condition', '')[:30]|replace('"', "'") %}
    {{ from_id }} -->|"{{ condition_label }}..."| {{ to_id }}
{%- else %}
    {{ from_id }} --> {{ to_id }}
{%- endif -%}
{%- endfor -%}
{%- endif -%}
{%- endif -%}
{%- endmacro %}

{# Now render the actual diagram using the macro #}
<div class="flow-diagram-view">
    <div class="diagram-controls">
        <h5><i class="fas fa-project-diagram"></i> Process Flow Visualization</h5>
        <div class="diagram-legend">
            <span class="legend-item">
                <span class="legend-box added"></span> Added
            </span>
            <span class="legend-item">
                <span class="legend-box removed"></span> Removed
            </span>
            <span class="legend-item">
                <span class="legend-box modified"></span> Modified
            </span>
            <span class="legend-item">
                <span class="legend-box unchanged"></span> Unchanged
            </span>
        </div>
    </div>
    

    
    <div class="diagram-container">
        <div class="mermaid" id="process-flow-diagram">
            {{ _generate_comparison_diagram(change.process_model_data) }}
        </div>
    </div>
    
    <div class="diagram-info">
        <p class="text-muted">
            <i class="fas fa-info-circle"></i>
            This diagram shows the process flow with color-coded nodes indicating changes.
            Hover over nodes for details. Use your browser's zoom controls to adjust the view.
        </p>
    </div>
</div>

<style>
.flow-diagram-view {
    padding: 1.5rem;
}

.diagram-controls {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
    flex-wrap: wrap;
    gap: 1rem;
}

.diagram-controls h5 {
    margin: 0;
    color: var(--text-primary);
    font-size: 1rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.diagram-legend {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
}

.legend-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.875rem;
    color: var(--text-secondary);
}

.legend-box {
    width: 20px;
    height: 20px;
    border-radius: 4px;
    border: 2px solid;
}

.legend-box.added {
    background: #10b981;
    border-color: #059669;
}

.legend-box.removed {
    background: #ef4444;
    border-color: #dc2626;
}

.legend-box.modified {
    background: #f59e0b;
    border-color: #d97706;
}

.legend-box.unchanged {
    background: #3b82f6;
    border-color: #2563eb;
}

.diagram-container {
    background: rgba(0, 0, 0, 0.2);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 2rem;
    overflow-x: auto;
    min-height: 400px;
}

#process-flow-diagram {
    display: flex;
    justify-content: center;
    align-items: center;
}

.diagram-info {
    margin-top: 1rem;
    padding: 1rem;
    background: rgba(59, 130, 246, 0.05);
    border: 1px solid rgba(59, 130, 246, 0.3);
    border-radius: 6px;
}

.diagram-info p {
    margin: 0;
    font-size: 0.875rem;
    color: var(--text-secondary);
    display: flex;
    align-items: flex-start;
    gap: 0.5rem;
}

.diagram-info i {
    color: #3b82f6;
    margin-top: 0.125rem;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .diagram-controls {
        flex-direction: column;
        align-items: flex-start;
    }
    
    .diagram-container {
        padding: 1rem;
    }
}
</style>
