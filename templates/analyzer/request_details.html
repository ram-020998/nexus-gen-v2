{% extends "base.html" %}

{% block title %}Comparison Details - {{ comparison_request.reference_id }}{% endblock %}

{% block page_title %}Comparison Results{% endblock %}
{% block page_subtitle %}{{ comparison_request.reference_id }} - {{ comparison_request.old_app_name }} vs {{ comparison_request.new_app_name }}{% endblock %}

{% block content %}
{% if comparison_request.status == 'completed' and comparison_request.comparison_results %}
    {% set comparison = comparison_request.comparison_results | from_json %}
{% endif %}

<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h4>
                    {{ comparison_request.reference_id }}
                    {% if comparison %}
                    <span class="badge bg-{{ 'danger' if comparison.comparison_summary.impact_level == 'HIGH' else 'warning' if comparison.comparison_summary.impact_level == 'MEDIUM' else 'success' }} ms-2">
                        {{ comparison.comparison_summary.impact_level }} Impact
                    </span>
                    {% endif %}
                </h4>
                <p class="text-muted mb-0">
                    Created: {{ comparison_request.created_at.strftime('%Y-%m-%d %H:%M:%S') }} | 
                    Processing Time: {{ comparison_request.total_time or 0 }}s
                </p>
            </div>
            <div>
                {% if comparison_request.status == 'completed' %}
                    <span class="badge bg-success fs-6">Completed</span>
                {% elif comparison_request.status == 'processing' %}
                    <span class="badge bg-warning fs-6">Processing</span>
                {% else %}
                    <span class="badge bg-danger fs-6">Error</span>
                {% endif %}
            </div>
        </div>
    </div>
</div>

{% if comparison_request.status == 'completed' and comparison_request.comparison_results %}
    
    <!-- Summary Cards at Top -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="metric-card">
                <div class="metric-value text-success">{{ comparison.changes_by_category.values() | map(attribute='added') | sum }}</div>
                <div class="metric-label">Objects Added</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="metric-card">
                <div class="metric-value text-danger">{{ comparison.changes_by_category.values() | map(attribute='removed') | sum }}</div>
                <div class="metric-label">Objects Removed</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="metric-card">
                <div class="metric-value text-warning">{{ comparison.changes_by_category.values() | map(attribute='modified') | sum }}</div>
                <div class="metric-label">Objects Modified</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="metric-card">
                <div class="metric-value text-primary">{{ comparison.comparison_summary.total_changes }}</div>
                <div class="metric-label">Total Changes</div>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="filter-panel">
                <div class="panel-header">
                    <div class="panel-icon">
                        <i class="fas fa-filter"></i>
                    </div>
                    <h5>Filters</h5>
                </div>
                <div class="filter-content">
                    <div class="row">
                        <div class="col-md-6">
                            <label class="form-label">Object Types</label>
                            <div class="dropdown w-100">
                                <button class="btn btn-outline-secondary dropdown-toggle w-100" type="button" id="objectTypeDropdown" data-bs-toggle="dropdown">
                                    Select Object Types
                                </button>
                                <div class="dropdown-menu" id="objectTypeMenu">
                                    {% for category in comparison.changes_by_category.keys() %}
                                    <div class="dropdown-item">
                                        <div class="form-check">
                                            <input class="form-check-input object-type-filter" type="checkbox" value="{{ category }}" id="obj_{{ category }}">
                                            <label class="form-check-label" for="obj_{{ category }}">
                                                {{ category.replace('_', ' ').title() }}
                                            </label>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Change Types</label>
                            <div class="dropdown w-100">
                                <button class="btn btn-outline-secondary dropdown-toggle w-100" type="button" id="changeTypeDropdown" data-bs-toggle="dropdown">
                                    Select Change Types
                                </button>
                                <div class="dropdown-menu" id="changeTypeMenu">
                                    <div class="dropdown-item">
                                        <div class="form-check">
                                            <input class="form-check-input change-type-filter" type="checkbox" value="ADDED" id="change_added">
                                            <label class="form-check-label" for="change_added">
                                                <span class="badge bg-success me-2">Added</span>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="dropdown-item">
                                        <div class="form-check">
                                            <input class="form-check-input change-type-filter" type="checkbox" value="REMOVED" id="change_removed">
                                            <label class="form-check-label" for="change_removed">
                                                <span class="badge bg-danger me-2">Removed</span>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="dropdown-item">
                                        <div class="form-check">
                                            <input class="form-check-input change-type-filter" type="checkbox" value="MODIFIED" id="change_modified">
                                            <label class="form-check-label" for="change_modified">
                                                <span class="badge bg-warning me-2">Modified</span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Changes Container - Full Width -->
    <div class="row" id="changesContainer" style="display: none;">
        <div class="col-12">
            <div class="results-panel">
                <div class="panel-header">
                    <div class="panel-icon">
                        <i class="fas fa-list"></i>
                    </div>
                    <h5 id="resultsTitle">Filtered Results</h5>
                </div>
                <div class="panel-content">
                    <div id="filteredResults">
                        <!-- Results will be populated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Hidden data for JavaScript -->
    <script type="application/json" id="comparisonData">{{ comparison | tojson }}</script>

{% elif comparison_request.status == 'error' %}
    <div class="alert alert-danger">
        <h5><i class="fas fa-exclamation-triangle"></i> Processing Failed</h5>
        <p>{{ comparison_request.error_log or 'Unknown error occurred during processing.' }}</p>
    </div>
{% else %}
    <div class="alert alert-info">
        <h5><i class="fas fa-spinner fa-spin"></i> Processing in Progress</h5>
        <p>Your comparison request is being processed. Please refresh the page to check for updates.</p>
    </div>
{% endif %}

<style>
.metric-card {
    background: var(--bg-card);
    border-radius: 12px;
    padding: 1.5rem;
    text-align: center;
    border: 1px solid #374151;
    margin-bottom: 1rem;
}

.metric-value {
    font-size: 2rem;
    font-weight: 700;
    color: white;
}

.metric-label {
    color: var(--text-secondary);
    font-size: 0.875rem;
    margin-top: 0.5rem;
}

.results-panel {
    background: var(--bg-card);
    border-radius: 12px;
    border: 1px solid #374151;
    margin-bottom: 1.5rem;
    display: flex;
    flex-direction: column;
}

.filter-panel {
    background: var(--bg-card);
    border-radius: 12px;
    border: 1px solid #374151;
    margin-bottom: 1.5rem;
}

.filter-content {
    padding: 1rem 1.5rem 1.5rem;
}

.panel-header {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 1.5rem 1.5rem 0;
    flex-shrink: 0;
}

.panel-icon {
    width: 32px;
    height: 32px;
    background: rgba(16, 185, 129, 0.2);
    color: var(--emerald);
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.panel-icon.bg-success {
    background: rgba(34, 197, 94, 0.2);
    color: #22c55e;
}

.panel-icon.bg-danger {
    background: rgba(239, 68, 68, 0.2);
    color: #ef4444;
}

.panel-icon.bg-warning {
    background: rgba(245, 158, 11, 0.2);
    color: #f59e0b;
}

.panel-content {
    flex: 1;
    padding: 1rem 1.5rem 1.5rem;
    overflow-y: auto;
    overflow-x: hidden;
}

.category-summary {
    padding: 0.75rem;
    background: rgba(16, 185, 129, 0.1);
    border-radius: 6px;
}

.change-item {
    background: var(--bg-primary);
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 0.75rem;
    border-left: 4px solid transparent;
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    width: 100%;
    box-sizing: border-box;
    overflow: hidden;
}

.change-item.change-added {
    border-left-color: #22c55e;
}

.change-item.change-removed {
    border-left-color: #ef4444;
}

.change-item.change-modified {
    border-left-color: #f59e0b;
}

.change-header {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 0.5rem;
    flex-wrap: wrap;
    flex: 1;
    min-width: 0;
}

.change-type-badge {
    font-size: 0.75rem;
}

.object-name {
    font-weight: 600;
    color: var(--text-primary);
}

.change-details {
    margin-top: 0.5rem;
    padding-left: 1rem;
    border-left: 2px solid #374151;
}

.change-detail {
    color: var(--text-secondary);
    font-size: 0.875rem;
    margin-bottom: 0.25rem;
}

/* Updated styles for improved UI */
.changes-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 1rem;
}

.change-actions {
    flex-shrink: 0;
}

.view-details-btn {
    border-color: var(--primary);
    color: var(--primary);
}

.view-details-btn:hover {
    background-color: var(--primary);
    border-color: var(--primary);
    color: white;
}

.modal-content {
    background: var(--bg-card) !important;
    border: 1px solid #374151;
}

.modal-header {
    border-bottom: 1px solid #374151;
}

.modal-title {
    color: var(--text-primary);
}

.object-detail-section {
    margin-bottom: 1.5rem;
}

.object-detail-section h6 {
    color: var(--emerald);
    margin-bottom: 0.75rem;
}

.object-detail-content {
    background: var(--bg-primary);
    padding: 1rem;
    border-radius: 8px;
    border-left: 4px solid var(--emerald);
}

.change-list {
    list-style: none;
    padding: 0;
}

.change-list li {
    padding: 0.5rem 0;
    border-bottom: 1px solid #374151;
    color: var(--text-secondary);
}

.change-list li:last-child {
    border-bottom: none;
}

.metric-value {
    font-size: 2rem;
    font-weight: 700;
}

.object-item {
    background: rgba(16, 185, 129, 0.1);
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 0.75rem;
}

.object-name {
    font-weight: 600;
    color: var(--text-primary);
}

.object-type {
    font-size: 0.875rem;
    color: var(--emerald);
    margin-bottom: 0.5rem;
}

.object-description {
    color: var(--text-secondary);
    font-size: 0.875rem;
}

.modified-object-item {
    background: rgba(245, 158, 11, 0.1);
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 0.75rem;
}

.object-header {
    margin-bottom: 0.75rem;
}

.changes-list {
    border-left: 3px solid #f59e0b;
    padding-left: 1rem;
}

.comparison-item {
    margin-bottom: 1rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid #374151;
}

.old-value {
    color: #ef4444;
}

.new-value {
    color: #22c55e;
}

.impact-level {
    padding: 0.5rem 1rem;
    border-radius: 6px;
    font-weight: 600;
    margin-bottom: 1rem;
}

.impact-low {
    background: rgba(34, 197, 94, 0.2);
    color: #22c55e;
}

.impact-medium {
    background: rgba(245, 158, 11, 0.2);
    color: #f59e0b;
}

.impact-high {
    background: rgba(239, 68, 68, 0.2);
    color: #ef4444;
}

.object-count-change {
    font-size: 1.1rem;
    margin-bottom: 1rem;
}

.empty-state {
    text-align: center;
    color: var(--text-secondary);
    padding: 2rem;
}

.empty-state i {
    font-size: 2rem;
    margin-bottom: 1rem;
}

.code-block {
    background: var(--bg-primary);
    border: 1px solid #374151;
    border-radius: 6px;
    padding: 1rem;
    font-family: 'Courier New', monospace;
    font-size: 0.875rem;
    color: var(--text-primary);
    white-space: pre-wrap;
    word-wrap: break-word;
    max-height: 300px;
    overflow-y: auto;
    margin-bottom: 1rem;
}

.old-code {
    border-left: 4px solid #ef4444;
}

.new-code {
    border-left: 4px solid #22c55e;
}

.dropdown-menu {
    background-color: var(--bg-card) !important;
    border: 1px solid #374151 !important;
    border-radius: 8px !important;
    width: 100% !important;
}

.dropdown-item {
    color: var(--text-primary) !important;
}

.dropdown-item:hover,
.dropdown-item:focus {
    background-color: var(--bg-primary) !important;
    color: var(--text-primary) !important;
}

.form-check-label {
    color: var(--text-primary) !important;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const comparisonData = JSON.parse(document.getElementById('comparisonData').textContent);
    const changesContainer = document.getElementById('changesContainer');
    const filteredResults = document.getElementById('filteredResults');
    const resultsTitle = document.getElementById('resultsTitle');
    
    let selectedObjectTypes = [];
    let selectedChangeTypes = [];
    
    // Multi-select dropdown functionality
    function updateDropdownText(dropdownId, selectedItems, allItems) {
        const button = document.getElementById(dropdownId);
        if (selectedItems.length === 0) {
            button.textContent = dropdownId === 'objectTypeDropdown' ? 'Select Object Types' : 'Select Change Types';
        } else if (selectedItems.length === allItems.length) {
            button.textContent = 'All Selected';
        } else {
            button.textContent = `${selectedItems.length} Selected`;
        }
    }
    
    // Object type filter handlers
    document.querySelectorAll('.object-type-filter').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            if (this.checked) {
                selectedObjectTypes.push(this.value);
            } else {
                selectedObjectTypes = selectedObjectTypes.filter(type => type !== this.value);
            }
            updateDropdownText('objectTypeDropdown', selectedObjectTypes, Object.keys(comparisonData.changes_by_category));
            applyFilters();
        });
    });
    
    // Change type filter handlers
    document.querySelectorAll('.change-type-filter').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            if (this.checked) {
                selectedChangeTypes.push(this.value);
            } else {
                selectedChangeTypes = selectedChangeTypes.filter(type => type !== this.value);
            }
            updateDropdownText('changeTypeDropdown', selectedChangeTypes, ['ADDED', 'REMOVED', 'MODIFIED']);
            applyFilters();
        });
    });
    
    // Prevent dropdown from closing when clicking inside
    document.querySelectorAll('.dropdown-menu').forEach(menu => {
        menu.addEventListener('click', function(e) {
            e.stopPropagation();
        });
    });
    
    function applyFilters() {
        if (selectedObjectTypes.length === 0 && selectedChangeTypes.length === 0) {
            changesContainer.style.display = 'none';
            return;
        }
        
        changesContainer.style.display = 'block';
        
        let filteredData = [];
        
        // Filter by object types and change types
        Object.entries(comparisonData.changes_by_category).forEach(([category, changes]) => {
            if (selectedObjectTypes.length === 0 || selectedObjectTypes.includes(category)) {
                changes.details.forEach(detail => {
                    if (selectedChangeTypes.length === 0 || selectedChangeTypes.includes(detail.change_type)) {
                        filteredData.push({
                            ...detail,
                            category: category
                        });
                    }
                });
            }
        });
        
        displayFilteredResults(filteredData);
    }
    
    function displayFilteredResults(data) {
        if (data.length === 0) {
            filteredResults.innerHTML = `
                <div class="no-results">
                    <i class="fas fa-search"></i>
                    <p>No results found for the selected filters</p>
                </div>
            `;
            resultsTitle.textContent = 'No Results';
            return;
        }
        
        resultsTitle.textContent = `${data.length} Results Found`;
        
        const html = `
            <div class="changes-grid">
                ${data.map(item => `
                    <div class="change-item change-${item.change_type.toLowerCase()}">
                        <div class="change-header">
                            <span class="change-type-badge badge bg-${item.change_type === 'ADDED' ? 'success' : item.change_type === 'REMOVED' ? 'danger' : 'warning'}">
                                ${item.change_type}
                            </span>
                            <span class="object-name">${item.name}</span>
                            <small class="text-muted ms-2">(${item.category.replace('_', ' ')})</small>
                        </div>
                        <div class="change-actions">
                            <a href="/analyzer/object/{{ comparison_request.id }}/${item.uuid}" 
                               target="_blank" 
                               class="btn btn-sm btn-outline-primary view-details-btn">
                                <i class="fas fa-external-link-alt"></i> View Details
                            </a>
                        </div>
                    </div>
                `).join('')}
            </div>
        `;
        
        filteredResults.innerHTML = html;
    }
});
</script>
{% endblock %}
