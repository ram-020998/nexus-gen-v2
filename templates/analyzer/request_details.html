{% extends "base.html" %}

{% block title %}Comparison Details - {{ comparison_request.reference_id }}{% endblock %}

{% block page_title %}Comparison Results{% endblock %}
{% block page_subtitle %}{{ comparison_request.reference_id }} - {{ comparison_request.old_app_name }} vs {{ comparison_request.new_app_name }}{% endblock %}

{% block content %}
{% if comparison_request.status == 'completed' and comparison_request.comparison_results %}
    {% set comparison = comparison_request.comparison_results | from_json %}
{% endif %}

<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h4>
                    {{ comparison_request.reference_id }}
                    {% if comparison %}
                    <span class="badge bg-{{ 'danger' if comparison.comparison_summary.impact_level == 'HIGH' else 'warning' if comparison.comparison_summary.impact_level == 'MEDIUM' else 'success' }} ms-2">
                        {{ comparison.comparison_summary.impact_level }} Impact
                    </span>
                    {% endif %}
                </h4>
                <p class="text-muted mb-0">
                    Created: {{ comparison_request.created_at.strftime('%Y-%m-%d %H:%M:%S') }} | 
                    Processing Time: {{ comparison_request.total_time or 0 }}s
                </p>
            </div>
            <div>
                {% if comparison_request.status == 'completed' %}
                    <span class="badge bg-success fs-6">Completed</span>
                {% elif comparison_request.status == 'processing' %}
                    <span class="badge bg-warning fs-6">Processing</span>
                {% else %}
                    <span class="badge bg-danger fs-6">Error</span>
                {% endif %}
            </div>
        </div>
    </div>
</div>

{% if comparison_request.status == 'completed' and comparison_request.comparison_results %}
    
    <!-- Summary Cards at Top -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="metric-card">
                <div class="metric-value text-success">{{ comparison.changes_by_category.values() | map(attribute='added') | sum }}</div>
                <div class="metric-label">Objects Added</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="metric-card">
                <div class="metric-value text-danger">{{ comparison.changes_by_category.values() | map(attribute='removed') | sum }}</div>
                <div class="metric-label">Objects Removed</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="metric-card">
                <div class="metric-value text-warning">{{ comparison.changes_by_category.values() | map(attribute='modified') | sum }}</div>
                <div class="metric-label">Objects Modified</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="metric-card">
                <div class="metric-value text-primary">{{ comparison.comparison_summary.total_changes }}</div>
                <div class="metric-label">Total Changes</div>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="filter-panel">
                <div class="panel-header">
                    <div class="panel-icon">
                        <i class="fas fa-filter"></i>
                    </div>
                    <h5>Filters</h5>
                </div>
                <div class="filter-content">
                    <div class="row">
                        <div class="col-md-6">
                            <label class="form-label">Object Types</label>
                            <div class="dropdown w-100">
                                <button class="btn btn-outline-secondary dropdown-toggle w-100" type="button" id="objectTypeDropdown" data-bs-toggle="dropdown">
                                    Select Object Types
                                </button>
                                <div class="dropdown-menu" id="objectTypeMenu">
                                    {% for category in comparison.changes_by_category.keys() %}
                                    <div class="dropdown-item">
                                        <div class="form-check">
                                            <input class="form-check-input object-type-filter" type="checkbox" value="{{ category }}" id="obj_{{ category }}">
                                            <label class="form-check-label" for="obj_{{ category }}">
                                                {{ category.replace('_', ' ').title() }}
                                            </label>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Change Types</label>
                            <div class="dropdown w-100">
                                <button class="btn btn-outline-secondary dropdown-toggle w-100" type="button" id="changeTypeDropdown" data-bs-toggle="dropdown">
                                    Select Change Types
                                </button>
                                <div class="dropdown-menu" id="changeTypeMenu">
                                    <div class="dropdown-item">
                                        <div class="form-check">
                                            <input class="form-check-input change-type-filter" type="checkbox" value="ADDED" id="change_added">
                                            <label class="form-check-label" for="change_added">
                                                <span class="badge bg-success me-2">Added</span>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="dropdown-item">
                                        <div class="form-check">
                                            <input class="form-check-input change-type-filter" type="checkbox" value="REMOVED" id="change_removed">
                                            <label class="form-check-label" for="change_removed">
                                                <span class="badge bg-danger me-2">Removed</span>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="dropdown-item">
                                        <div class="form-check">
                                            <input class="form-check-input change-type-filter" type="checkbox" value="MODIFIED" id="change_modified">
                                            <label class="form-check-label" for="change_modified">
                                                <span class="badge bg-warning me-2">Modified</span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Changes Container - Full Width -->
    <div class="row" id="changesContainer">
        <div class="col-12">
            <div class="results-panel">
                <div class="panel-header">
                    <div class="panel-icon">
                        <i class="fas fa-list"></i>
                    </div>
                    <h5 id="resultsTitle">All Changes</h5>
                </div>
                <div class="panel-content">
                    <div class="table-responsive">
                        <table class="table table-dark table-striped" id="changesTable">
                            <thead>
                                <tr>
                                    <th>Change Type</th>
                                    <th>Object Name</th>
                                    <th>Type</th>
                                    <th>Category</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="changesTableBody">
                                <!-- Results will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Pagination -->
                    <div class="pagination-container" id="changesPaginationContainer">
                        <div class="pagination-info">
                            Showing <span id="changesPageStart">1</span> to <span id="changesPageEnd">10</span> of <span id="changesTotalRows">0</span> entries
                        </div>
                        <nav>
                            <ul class="pagination" id="changesPagination">
                                <!-- Pagination buttons will be generated by JavaScript -->
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Hidden data for JavaScript -->
    <script type="application/json" id="comparisonData">{{ comparison | tojson }}</script>

{% elif comparison_request.status == 'error' %}
    <div class="alert alert-danger">
        <h5><i class="fas fa-exclamation-triangle"></i> Processing Failed</h5>
        <p>{{ comparison_request.error_log or 'Unknown error occurred during processing.' }}</p>
    </div>
{% else %}
    <div class="alert alert-info">
        <h5><i class="fas fa-spinner fa-spin"></i> Processing in Progress</h5>
        <p>Your comparison request is being processed. Please refresh the page to check for updates.</p>
    </div>
{% endif %}

<style>
.metric-card {
    background: var(--bg-card);
    border-radius: 12px;
    padding: 1.5rem;
    text-align: center;
    border: 1px solid #374151;
    margin-bottom: 1rem;
}

.metric-value {
    font-size: 2rem;
    font-weight: 700;
    color: white;
}

.metric-label {
    color: var(--text-secondary);
    font-size: 0.875rem;
    margin-top: 0.5rem;
}

.results-panel {
    background: var(--bg-card);
    border-radius: 12px;
    border: 1px solid #374151;
    margin-bottom: 1.5rem;
    display: flex;
    flex-direction: column;
}

.filter-panel {
    background: var(--bg-card);
    border-radius: 12px;
    border: 1px solid #374151;
    margin-bottom: 1.5rem;
}

.filter-content {
    padding: 1rem 1.5rem 1.5rem;
}

.panel-header {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 1.5rem 1.5rem 0;
    flex-shrink: 0;
}

.panel-icon {
    width: 32px;
    height: 32px;
    background: rgba(16, 185, 129, 0.2);
    color: var(--emerald);
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.panel-icon.bg-success {
    background: rgba(34, 197, 94, 0.2);
    color: #22c55e;
}

.panel-icon.bg-danger {
    background: rgba(239, 68, 68, 0.2);
    color: #ef4444;
}

.panel-icon.bg-warning {
    background: rgba(245, 158, 11, 0.2);
    color: #f59e0b;
}

.panel-content {
    flex: 1;
    padding: 1rem 1.5rem 1.5rem;
    overflow-y: auto;
    overflow-x: hidden;
}

.category-summary {
    padding: 0.75rem;
    background: rgba(16, 185, 129, 0.1);
    border-radius: 6px;
}

.pagination-container {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem 0;
    margin-top: 1rem;
    border-top: 1px solid #374151;
}

.pagination-info {
    color: var(--text-secondary);
    font-size: 0.875rem;
}

.pagination {
    margin: 0;
}

.pagination .page-link {
    background: var(--bg-primary);
    border: 1px solid #374151;
    color: var(--text-primary);
    padding: 0.5rem 0.75rem;
    margin: 0 0.25rem;
    border-radius: 6px;
}

.pagination .page-link:hover {
    background: var(--emerald);
    border-color: var(--emerald);
    color: white;
}

.pagination .page-item.active .page-link {
    background: var(--emerald);
    border-color: var(--emerald);
    color: white;
}

.pagination .page-item.disabled .page-link {
    opacity: 0.5;
    cursor: not-allowed;
}

.table {
    color: var(--text-primary);
}

.table thead th {
    border-bottom: 2px solid #374151;
    color: var(--text-primary);
    font-weight: 600;
}

.table tbody td {
    border-bottom: 1px solid #374151;
    vertical-align: middle;
}

.change-header {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 0.5rem;
    flex-wrap: wrap;
    flex: 1;
    min-width: 0;
}

.change-type-badge {
    font-size: 0.75rem;
}

.object-name {
    font-weight: 600;
    color: var(--text-primary);
}

.change-details {
    margin-top: 0.5rem;
    padding-left: 1rem;
    border-left: 2px solid #374151;
}

.change-detail {
    color: var(--text-secondary);
    font-size: 0.875rem;
    margin-bottom: 0.25rem;
}

/* Updated styles for improved UI */
.changes-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 1rem;
}

.change-actions {
    flex-shrink: 0;
}

.view-details-btn {
    border-color: var(--primary);
    color: var(--primary);
}

.view-details-btn:hover {
    background-color: var(--primary);
    border-color: var(--primary);
    color: white;
}

.modal-content {
    background: var(--bg-card) !important;
    border: 1px solid #374151;
}

.modal-header {
    border-bottom: 1px solid #374151;
}

.modal-title {
    color: var(--text-primary);
}

.object-detail-section {
    margin-bottom: 1.5rem;
}

.object-detail-section h6 {
    color: var(--emerald);
    margin-bottom: 0.75rem;
}

.object-detail-content {
    background: var(--bg-primary);
    padding: 1rem;
    border-radius: 8px;
    border-left: 4px solid var(--emerald);
}

.change-list {
    list-style: none;
    padding: 0;
}

.change-list li {
    padding: 0.5rem 0;
    border-bottom: 1px solid #374151;
    color: var(--text-secondary);
}

.change-list li:last-child {
    border-bottom: none;
}

.metric-value {
    font-size: 2rem;
    font-weight: 700;
}

.object-item {
    background: rgba(16, 185, 129, 0.1);
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 0.75rem;
}

.object-name {
    font-weight: 600;
    color: var(--text-primary);
}

.object-type {
    font-size: 0.875rem;
    color: var(--emerald);
    margin-bottom: 0.5rem;
}

.object-description {
    color: var(--text-secondary);
    font-size: 0.875rem;
}

.modified-object-item {
    background: rgba(245, 158, 11, 0.1);
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 0.75rem;
}

.object-header {
    margin-bottom: 0.75rem;
}

.changes-list {
    border-left: 3px solid #f59e0b;
    padding-left: 1rem;
}

.comparison-item {
    margin-bottom: 1rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid #374151;
}

.old-value {
    color: #ef4444;
}

.new-value {
    color: #22c55e;
}

.impact-level {
    padding: 0.5rem 1rem;
    border-radius: 6px;
    font-weight: 600;
    margin-bottom: 1rem;
}

.impact-low {
    background: rgba(34, 197, 94, 0.2);
    color: #22c55e;
}

.impact-medium {
    background: rgba(245, 158, 11, 0.2);
    color: #f59e0b;
}

.impact-high {
    background: rgba(239, 68, 68, 0.2);
    color: #ef4444;
}

.object-count-change {
    font-size: 1.1rem;
    margin-bottom: 1rem;
}

.empty-state {
    text-align: center;
    color: var(--text-secondary);
    padding: 2rem;
}

.empty-state i {
    font-size: 2rem;
    margin-bottom: 1rem;
}

.code-block {
    background: var(--bg-primary);
    border: 1px solid #374151;
    border-radius: 6px;
    padding: 1rem;
    font-family: 'Courier New', monospace;
    font-size: 0.875rem;
    color: var(--text-primary);
    white-space: pre-wrap;
    word-wrap: break-word;
    max-height: 300px;
    overflow-y: auto;
    margin-bottom: 1rem;
}

.old-code {
    border-left: 4px solid #ef4444;
}

.new-code {
    border-left: 4px solid #22c55e;
}

.dropdown-menu {
    background-color: var(--bg-card) !important;
    border: 1px solid #374151 !important;
    border-radius: 8px !important;
    width: 100% !important;
}

.dropdown-item {
    color: var(--text-primary) !important;
}

.dropdown-item:hover,
.dropdown-item:focus {
    background-color: var(--bg-primary) !important;
    color: var(--text-primary) !important;
}

.form-check-label {
    color: var(--text-primary) !important;
}

.form-label {
    color: var(--text-primary) !important;
    font-weight: 500;
}

.btn-outline-secondary {
    color: var(--text-primary) !important;
    border-color: #374151 !important;
}

.btn-outline-secondary:hover {
    background-color: var(--emerald) !important;
    border-color: var(--emerald) !important;
    color: white !important;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const comparisonData = JSON.parse(document.getElementById('comparisonData').textContent);
    const changesTableBody = document.getElementById('changesTableBody');
    const resultsTitle = document.getElementById('resultsTitle');
    
    let allChanges = [];
    let filteredChanges = [];
    let selectedObjectTypes = [];
    let selectedChangeTypes = [];
    
    const rowsPerPage = 10;
    let currentPage = 1;
    
    // Collect all changes
    Object.entries(comparisonData.changes_by_category).forEach(([category, changes]) => {
        changes.details.forEach(detail => {
            allChanges.push({
                ...detail,
                category: category
            });
        });
    });
    
    // Multi-select dropdown functionality
    function updateDropdownText(dropdownId, selectedItems, allItems) {
        const button = document.getElementById(dropdownId);
        if (selectedItems.length === 0) {
            button.textContent = dropdownId === 'objectTypeDropdown' ? 'Select Object Types' : 'Select Change Types';
        } else if (selectedItems.length === allItems.length) {
            button.textContent = 'All Selected';
        } else {
            button.textContent = `${selectedItems.length} Selected`;
        }
    }
    
    // Object type filter handlers
    document.querySelectorAll('.object-type-filter').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            if (this.checked) {
                selectedObjectTypes.push(this.value);
            } else {
                selectedObjectTypes = selectedObjectTypes.filter(type => type !== this.value);
            }
            updateDropdownText('objectTypeDropdown', selectedObjectTypes, Object.keys(comparisonData.changes_by_category));
            applyFilters();
        });
    });
    
    // Change type filter handlers
    document.querySelectorAll('.change-type-filter').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            if (this.checked) {
                selectedChangeTypes.push(this.value);
            } else {
                selectedChangeTypes = selectedChangeTypes.filter(type => type !== this.value);
            }
            updateDropdownText('changeTypeDropdown', selectedChangeTypes, ['ADDED', 'REMOVED', 'MODIFIED']);
            applyFilters();
        });
    });
    
    // Prevent dropdown from closing when clicking inside
    document.querySelectorAll('.dropdown-menu').forEach(menu => {
        menu.addEventListener('click', function(e) {
            e.stopPropagation();
        });
    });
    
    function applyFilters() {
        filteredChanges = allChanges.filter(item => {
            const matchesObjectType = selectedObjectTypes.length === 0 || selectedObjectTypes.includes(item.category);
            const matchesChangeType = selectedChangeTypes.length === 0 || selectedChangeTypes.includes(item.change_type);
            return matchesObjectType && matchesChangeType;
        });
        
        currentPage = 1;
        displayChanges();
    }
    
    function displayChanges() {
        const dataToDisplay = filteredChanges.length > 0 || selectedObjectTypes.length > 0 || selectedChangeTypes.length > 0 
            ? filteredChanges 
            : allChanges;
        
        const totalRows = dataToDisplay.length;
        const totalPages = Math.ceil(totalRows / rowsPerPage);
        const start = (currentPage - 1) * rowsPerPage;
        const end = start + rowsPerPage;
        const pageData = dataToDisplay.slice(start, end);
        
        // Update title
        if (selectedObjectTypes.length > 0 || selectedChangeTypes.length > 0) {
            resultsTitle.textContent = `Filtered Results (${totalRows} of ${allChanges.length})`;
        } else {
            resultsTitle.textContent = `All Changes (${totalRows})`;
        }
        
        // Update table
        if (pageData.length === 0) {
            changesTableBody.innerHTML = `
                <tr>
                    <td colspan="5" class="text-center py-4">
                        <i class="fas fa-search fa-2x mb-2" style="color: var(--text-secondary);"></i>
                        <p style="color: var(--text-secondary);">No results found</p>
                    </td>
                </tr>
            `;
        } else {
            changesTableBody.innerHTML = pageData.map(item => `
                <tr>
                    <td>
                        <span class="badge bg-${item.change_type === 'ADDED' ? 'success' : item.change_type === 'REMOVED' ? 'danger' : 'warning'}">
                            ${item.change_type}
                        </span>
                    </td>
                    <td style="color: var(--text-primary); font-weight: 500;">${item.name}</td>
                    <td style="color: var(--text-secondary);">${item.type}</td>
                    <td style="color: var(--text-secondary);">${item.category.replace('_', ' ').title()}</td>
                    <td>
                        <a href="/analyzer/object/{{ comparison_request.id }}/${item.uuid}" 
                           target="_blank" 
                           class="btn btn-sm btn-outline-primary">
                            <i class="fas fa-external-link-alt"></i> View
                        </a>
                    </td>
                </tr>
            `).join('');
        }
        
        // Update pagination info
        document.getElementById('changesPageStart').textContent = totalRows > 0 ? start + 1 : 0;
        document.getElementById('changesPageEnd').textContent = Math.min(end, totalRows);
        document.getElementById('changesTotalRows').textContent = totalRows;
        
        // Update pagination buttons
        updatePaginationButtons(currentPage, totalPages);
    }
    
    function updatePaginationButtons(page, totalPages) {
        const pagination = document.getElementById('changesPagination');
        pagination.innerHTML = '';
        
        if (totalPages <= 1) return;
        
        // Previous button
        const prevLi = document.createElement('li');
        prevLi.className = `page-item ${page === 1 ? 'disabled' : ''}`;
        prevLi.innerHTML = `<a class="page-link" href="#" data-page="${page - 1}"><i class="fas fa-chevron-left"></i></a>`;
        pagination.appendChild(prevLi);
        
        // Page numbers
        const maxButtons = 5;
        let startPage = Math.max(1, page - Math.floor(maxButtons / 2));
        let endPage = Math.min(totalPages, startPage + maxButtons - 1);
        
        if (endPage - startPage < maxButtons - 1) {
            startPage = Math.max(1, endPage - maxButtons + 1);
        }
        
        if (startPage > 1) {
            const firstLi = document.createElement('li');
            firstLi.className = 'page-item';
            firstLi.innerHTML = `<a class="page-link" href="#" data-page="1">1</a>`;
            pagination.appendChild(firstLi);
            
            if (startPage > 2) {
                const dotsLi = document.createElement('li');
                dotsLi.className = 'page-item disabled';
                dotsLi.innerHTML = `<span class="page-link">...</span>`;
                pagination.appendChild(dotsLi);
            }
        }
        
        for (let i = startPage; i <= endPage; i++) {
            const li = document.createElement('li');
            li.className = `page-item ${i === page ? 'active' : ''}`;
            li.innerHTML = `<a class="page-link" href="#" data-page="${i}">${i}</a>`;
            pagination.appendChild(li);
        }
        
        if (endPage < totalPages) {
            if (endPage < totalPages - 1) {
                const dotsLi = document.createElement('li');
                dotsLi.className = 'page-item disabled';
                dotsLi.innerHTML = `<span class="page-link">...</span>`;
                pagination.appendChild(dotsLi);
            }
            
            const lastLi = document.createElement('li');
            lastLi.className = 'page-item';
            lastLi.innerHTML = `<a class="page-link" href="#" data-page="${totalPages}">${totalPages}</a>`;
            pagination.appendChild(lastLi);
        }
        
        // Next button
        const nextLi = document.createElement('li');
        nextLi.className = `page-item ${page === totalPages ? 'disabled' : ''}`;
        nextLi.innerHTML = `<a class="page-link" href="#" data-page="${page + 1}"><i class="fas fa-chevron-right"></i></a>`;
        pagination.appendChild(nextLi);
        
        // Add click handlers
        pagination.querySelectorAll('a.page-link').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                const newPage = parseInt(this.dataset.page);
                const totalPages = Math.ceil((filteredChanges.length > 0 || selectedObjectTypes.length > 0 || selectedChangeTypes.length > 0 ? filteredChanges : allChanges).length / rowsPerPage);
                if (newPage >= 1 && newPage <= totalPages) {
                    currentPage = newPage;
                    displayChanges();
                }
            });
        });
    }
    
    // String title case helper
    String.prototype.title = function() {
        return this.split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()).join(' ');
    };
    
    // Initialize display
    displayChanges();
});
</script>
{% endblock %}
