<!-- Process Model Comparison Component -->
{% if comparison and comparison.object_type == 'Process Model' %}
<div class="comparison-section">
    <div class="comparison-header">
        <h5><i class="fas fa-project-diagram"></i> Process Model Details</h5>
    </div>
    
    <div class="comparison-body">
        <!-- Tabs for Node Changes, Flow Changes, and Variables -->
        <ul class="nav nav-tabs comparison-tabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="nodes-tab" data-bs-toggle="tab" data-bs-target="#nodes-content" type="button" role="tab">
                    <i class="fas fa-circle"></i> Node Changes
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="flows-tab" data-bs-toggle="tab" data-bs-target="#flows-content" type="button" role="tab">
                    <i class="fas fa-arrow-right"></i> Flow Changes
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="variables-tab" data-bs-toggle="tab" data-bs-target="#variables-content" type="button" role="tab">
                    <i class="fas fa-dollar-sign"></i> Variables
                </button>
            </li>
        </ul>
        
        <div class="tab-content comparison-tab-content">
            <!-- Node Changes Tab -->
            <div class="tab-pane fade show active" id="nodes-content" role="tabpanel">
                <div class="comparison-grid">
                    {% if detail.change.classification == 'CONFLICT' %}
                        <!-- CONFLICT: Vendor Latest (left) vs Customer (right) -->
                        <div class="version-column vendor-column">
                            <div class="version-header">
                                <span class="badge bg-info">{{ comparison.new_label or 'Vendor Latest' }}</span>
                            </div>
                            <div class="version-content">
                                {% if comparison.vendor.nodes %}
                                <table class="nodes-table">
                                    <thead>
                                        <tr>
                                            <th>Node Name</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for node in comparison.vendor.nodes %}
                                        <tr>
                                            <td>{{ node.name }}</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                                {% else %}
                                <p class="text-muted">No nodes</p>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="version-column customer-column">
                            <div class="version-header">
                                <span class="badge bg-success">{{ comparison.new_label or 'Customer' }}</span>
                            </div>
                            <div class="version-content">
                                {% if comparison.customer.nodes %}
                                <table class="nodes-table">
                                    <thead>
                                        <tr>
                                            <th>Node Name</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for node in comparison.customer.nodes %}
                                        {% set vendor_node = comparison.vendor.nodes | selectattr('node_id', 'equalto', node.node_id) | first %}
                                        <tr class="{% if not vendor_node %}highlight-added{% elif vendor_node.name != node.name or vendor_node.type != node.type %}highlight-diff{% endif %}">
                                            <td>{{ node.name }}</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                                {% else %}
                                <p class="text-muted">No nodes</p>
                                {% endif %}
                            </div>
                        </div>
                    {% else %}
                        <!-- NO_CONFLICT: Dynamic based on change types -->
                        <div class="version-column vendor-column">
                            <div class="version-header">
                                <span class="badge bg-secondary">{{ comparison.old_label or 'Vendor Base' }}</span>
                            </div>
                            <div class="version-content">
                                {% if comparison.customer.nodes %}
                                <table class="nodes-table">
                                    <thead>
                                        <tr>
                                            <th>Node Name</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for node in comparison.customer.nodes %}
                                        <tr>
                                            <td>{{ node.name }}</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                                {% else %}
                                <p class="text-muted">No nodes</p>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="version-column customer-column">
                            <div class="version-header">
                                <span class="badge bg-info">{{ comparison.new_label or 'Vendor Latest' }}</span>
                            </div>
                            <div class="version-content">
                                {% if comparison.vendor.nodes %}
                                <table class="nodes-table">
                                    <thead>
                                        <tr>
                                            <th>Node Name</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for node in comparison.vendor.nodes %}
                                        {% set base_node = comparison.customer.nodes | selectattr('node_id', 'equalto', node.node_id) | first %}
                                        <tr class="{% if not base_node %}highlight-added{% elif base_node.name != node.name or base_node.type != node.type %}highlight-diff{% endif %}">
                                            <td>{{ node.name }}</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                                {% else %}
                                <p class="text-muted">No nodes</p>
                                {% endif %}
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Flow Changes Tab -->
            <div class="tab-pane fade" id="flows-content" role="tabpanel">
                <div class="flow-diagrams">
                    {% if detail.change.classification == 'CONFLICT' %}
                        <!-- CONFLICT: Vendor Latest (left) vs Customer (right) -->
                        <div class="diagram-section">
                            <div class="diagram-header">
                                <span class="badge bg-info">{{ comparison.new_label or 'Vendor Latest' }}</span>
                            </div>
                            <div class="mermaid-container">
                                {% if comparison.vendor.mermaid_diagram %}
                                <pre class="mermaid">{{ comparison.vendor.mermaid_diagram }}</pre>
                                {% else %}
                                <p class="text-muted">No flow diagram available</p>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="diagram-section">
                            <div class="diagram-header">
                                <span class="badge bg-success">{{ comparison.new_label or 'Customer' }}</span>
                            </div>
                            <div class="mermaid-container">
                                {% if comparison.customer.mermaid_diagram %}
                                <pre class="mermaid">{{ comparison.customer.mermaid_diagram }}</pre>
                                {% else %}
                                <p class="text-muted">No flow diagram available</p>
                                {% endif %}
                            </div>
                        </div>
                    {% else %}
                        <!-- NO_CONFLICT: Dynamic based on change types -->
                        <div class="diagram-section">
                            <div class="diagram-header">
                                <span class="badge bg-secondary">{{ comparison.old_label or 'Vendor Base' }}</span>
                            </div>
                            <div class="mermaid-container">
                                {% if comparison.customer.mermaid_diagram %}
                                <pre class="mermaid">{{ comparison.customer.mermaid_diagram }}</pre>
                                {% else %}
                                <p class="text-muted">No flow diagram available</p>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="diagram-section">
                            <div class="diagram-header">
                                <span class="badge bg-info">{{ comparison.new_label or 'Vendor Latest' }}</span>
                            </div>
                            <div class="mermaid-container">
                                {% if comparison.vendor.mermaid_diagram %}
                                <pre class="mermaid">{{ comparison.vendor.mermaid_diagram }}</pre>
                                {% else %}
                                <p class="text-muted">No flow diagram available</p>
                                {% endif %}
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Variables Tab -->
            <div class="tab-pane fade" id="variables-content" role="tabpanel">
                <div class="comparison-grid">
                    {% if detail.change.classification == 'CONFLICT' %}
                        <!-- CONFLICT: Vendor Latest (left) vs Customer (right) -->
                        <div class="version-column vendor-column">
                            <div class="version-header">
                                <span class="badge bg-info">{{ comparison.new_label or 'Vendor Latest' }}</span>
                            </div>
                            <div class="version-content">
                                {% if comparison.vendor.variables %}
                                <div class="variables-grid">
                                    {% for variable in comparison.vendor.variables %}
                                    <div class="variable-card">
                                        <div class="variable-card-header">
                                            <code class="variable-name">{{ variable.variable_name }}</code>
                                            {% if variable.is_parameter %}
                                            <span class="badge bg-primary variable-badge">
                                                <i class="fas fa-arrow-right"></i> Parameter
                                            </span>
                                            {% endif %}
                                        </div>
                                        <div class="variable-card-body">
                                            <div class="variable-type">
                                                <i class="fas fa-tag"></i>
                                                <span>{{ variable.variable_type }}</span>
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                                {% else %}
                                <p class="text-muted">No variables</p>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="version-column customer-column">
                            <div class="version-header">
                                <span class="badge bg-success">{{ comparison.new_label or 'Customer' }}</span>
                            </div>
                            <div class="version-content">
                                {% if comparison.customer.variables %}
                                <div class="variables-grid">
                                    {% for variable in comparison.customer.variables %}
                                    {% set vendor_var = comparison.vendor.variables | selectattr('variable_name', 'equalto', variable.variable_name) | first %}
                                    <div class="variable-card {% if not vendor_var %}highlight-added{% elif vendor_var.variable_type != variable.variable_type or vendor_var.is_parameter != variable.is_parameter %}highlight-diff{% endif %}">
                                        <div class="variable-card-header">
                                            <code class="variable-name">{{ variable.variable_name }}</code>
                                            {% if variable.is_parameter %}
                                            <span class="badge bg-primary variable-badge">
                                                <i class="fas fa-arrow-right"></i> Parameter
                                            </span>
                                            {% endif %}
                                        </div>
                                        <div class="variable-card-body">
                                            <div class="variable-type">
                                                <i class="fas fa-tag"></i>
                                                <span>{{ variable.variable_type }}</span>
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                                {% else %}
                                <p class="text-muted">No variables</p>
                                {% endif %}
                            </div>
                        </div>
                    {% else %}
                        <!-- NO_CONFLICT: Dynamic based on change types -->
                        <div class="version-column vendor-column">
                            <div class="version-header">
                                <span class="badge bg-secondary">{{ comparison.old_label or 'Vendor Base' }}</span>
                            </div>
                            <div class="version-content">
                                {% if comparison.customer.variables %}
                                <div class="variables-grid">
                                    {% for variable in comparison.customer.variables %}
                                    <div class="variable-card">
                                        <div class="variable-card-header">
                                            <code class="variable-name">{{ variable.variable_name }}</code>
                                            {% if variable.is_parameter %}
                                            <span class="badge bg-primary variable-badge">
                                                <i class="fas fa-arrow-right"></i> Parameter
                                            </span>
                                            {% endif %}
                                        </div>
                                        <div class="variable-card-body">
                                            <div class="variable-type">
                                                <i class="fas fa-tag"></i>
                                                <span>{{ variable.variable_type }}</span>
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                                {% else %}
                                <p class="text-muted">No variables</p>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="version-column customer-column">
                            <div class="version-header">
                                <span class="badge bg-info">{{ comparison.new_label or 'Vendor Latest' }}</span>
                            </div>
                            <div class="version-content">
                                {% if comparison.vendor.variables %}
                                <div class="variables-grid">
                                    {% for variable in comparison.vendor.variables %}
                                    {% set base_var = comparison.customer.variables | selectattr('variable_name', 'equalto', variable.variable_name) | first %}
                                    <div class="variable-card {% if not base_var %}highlight-added{% elif base_var.variable_type != variable.variable_type or base_var.is_parameter != variable.is_parameter %}highlight-diff{% endif %}">
                                        <div class="variable-card-header">
                                            <code class="variable-name">{{ variable.variable_name }}</code>
                                            {% if variable.is_parameter %}
                                            <span class="badge bg-primary variable-badge">
                                                <i class="fas fa-arrow-right"></i> Parameter
                                            </span>
                                            {% endif %}
                                        </div>
                                        <div class="variable-card-body">
                                            <div class="variable-type">
                                                <i class="fas fa-tag"></i>
                                                <span>{{ variable.variable_type }}</span>
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                                {% else %}
                                <p class="text-muted">No variables</p>
                                {% endif %}
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Include Mermaid.js for diagram rendering -->
<script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
<script>
    mermaid.initialize({ 
        startOnLoad: true,
        theme: 'dark',
        flowchart: {
            nodeSpacing: 50,
            rankSpacing: 80,
            padding: 15,
            useMaxWidth: true
        },
        themeVariables: {
            primaryColor: '#8b5cf6',
            primaryTextColor: '#fff',
            primaryBorderColor: '#7c3aed',
            lineColor: '#a78bfa',
            secondaryColor: '#14b8a6',
            tertiaryColor: '#f59e0b',
            fontSize: '14px'
        }
    });
    
    // Re-render Mermaid diagrams when Flow Changes tab is shown
    document.addEventListener('DOMContentLoaded', function() {
        const flowsTab = document.getElementById('flows-tab');
        if (flowsTab) {
            flowsTab.addEventListener('shown.bs.tab', function() {
                // Remove data-processed attribute to force re-render
                document.querySelectorAll('.mermaid[data-processed="true"]').forEach(function(el) {
                    el.removeAttribute('data-processed');
                    const originalText = el.getAttribute('data-original-text');
                    if (originalText) {
                        el.textContent = originalText;
                    }
                });
                // Re-initialize Mermaid
                mermaid.run();
            });
        }
        
        // Store original Mermaid text before first render
        document.querySelectorAll('.mermaid').forEach(function(el) {
            if (!el.hasAttribute('data-original-text')) {
                el.setAttribute('data-original-text', el.textContent);
            }
        });
    });
</script>
{% endif %}
