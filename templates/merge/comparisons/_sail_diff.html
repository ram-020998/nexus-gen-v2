<!-- GitHub-Style SAIL Code Diff Component -->
{% macro render_sail_diff(diff_hunks, old_label="Before", new_label="After", stats=None) %}
<div class="sail-diff-container">
    <!-- Diff Header -->
    <div class="diff-header">
        <div class="diff-file-info">
            <i class="fas fa-code"></i>
            <span class="diff-labels">
                <span class="old-label">{{ old_label }}</span>
                <i class="fas fa-arrow-right"></i>
                <span class="new-label">{{ new_label }}</span>
            </span>
        </div>
        <div class="diff-controls">
            {% if stats %}
            <div class="diff-stats">
                {% if stats.additions > 0 %}
                <span class="stat-additions">
                    <i class="fas fa-plus"></i> {{ stats.additions }}
                </span>
                {% endif %}
                {% if stats.deletions > 0 %}
                <span class="stat-deletions">
                    <i class="fas fa-minus"></i> {{ stats.deletions }}
                </span>
                {% endif %}
            </div>
            {% endif %}
            <div class="view-toggle">
                <button class="toggle-btn active" data-view="unified">
                    <i class="fas fa-align-left"></i> Unified
                </button>
                <button class="toggle-btn" data-view="split">
                    <i class="fas fa-columns"></i> Split
                </button>
            </div>
        </div>
    </div>
    
    <!-- Unified View -->
    <div class="diff-view unified-view active">
        {% if not diff_hunks or diff_hunks|length == 0 %}
        <div class="no-changes-message">
            <i class="fas fa-check-circle"></i>
            <span>No changes detected</span>
        </div>
        {% else %}
        {% for hunk in diff_hunks %}
        <div class="diff-hunk">
            <div class="hunk-header">
                <span class="hunk-range">
                    @@ -{{ hunk.old_start }},{{ hunk.old_count }} +{{ hunk.new_start }},{{ hunk.new_count }} @@
                </span>
            </div>
            <table class="hunk-table">
                {% for line in hunk.lines %}
                <tr class="diff-line diff-line-{{ line.line_type.value }}">
                    <td class="line-num old-line-num">{{ line.old_line_num if line.old_line_num else '' }}</td>
                    <td class="line-num new-line-num">{{ line.new_line_num if line.new_line_num else '' }}</td>
                    <td class="line-indicator">
                        {% if line.line_type.value == 'added' %}+{% elif line.line_type.value == 'removed' %}-{% else %} {% endif %}
                    </td>
                    <td class="line-content"><pre>{{ line.content }}</pre></td>
                </tr>
                {% endfor %}
            </table>
        </div>
        {% endfor %}
        {% endif %}
    </div>
    
    <!-- Split View -->
    <div class="diff-view split-view">
        {% if not diff_hunks or diff_hunks|length == 0 %}
        <div class="no-changes-message">
            <i class="fas fa-check-circle"></i>
            <span>No changes detected</span>
        </div>
        {% else %}
        <div class="split-container">
            <div class="split-side new-side">
                <div class="split-header">
                    <i class="fas fa-plus-circle"></i> {{ new_label }}
                </div>
                <div class="split-content">
                    {% for hunk in diff_hunks %}
                    <div class="split-hunk">
                        <div class="hunk-header-split">
                            @@ +{{ hunk.new_start }},{{ hunk.new_count }} @@
                        </div>
                        <table class="split-table">
                            {% for line in hunk.lines %}
                            {% if line.line_type.value != 'removed' %}
                            <tr class="split-line {% if line.line_type.value == 'added' %}added-line{% endif %}">
                                <td class="split-line-num">{{ line.new_line_num if line.new_line_num else '' }}</td>
                                <td class="split-line-content"><pre>{{ line.content }}</pre></td>
                            </tr>
                            {% endif %}
                            {% endfor %}
                        </table>
                    </div>
                    {% endfor %}
                </div>
            </div>
            <div class="split-side old-side">
                <div class="split-header">
                    <i class="fas fa-minus-circle"></i> {{ old_label }}
                </div>
                <div class="split-content">
                    {% for hunk in diff_hunks %}
                    <div class="split-hunk">
                        <div class="hunk-header-split">
                            @@ -{{ hunk.old_start }},{{ hunk.old_count }} @@
                        </div>
                        <table class="split-table">
                            {% for line in hunk.lines %}
                            {% if line.line_type.value != 'added' %}
                            <tr class="split-line {% if line.line_type.value == 'removed' %}removed-line{% endif %}">
                                <td class="split-line-num">{{ line.old_line_num if line.old_line_num else '' }}</td>
                                <td class="split-line-content"><pre>{{ line.content }}</pre></td>
                            </tr>
                            {% endif %}
                            {% endfor %}
                        </table>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<script>
(function() {
    // Handle view toggle
    const container = document.currentScript.previousElementSibling;
    const toggleBtns = container.querySelectorAll('.toggle-btn');
    const unifiedView = container.querySelector('.unified-view');
    const splitView = container.querySelector('.split-view');
    const oldSideContent = container.querySelector('.old-side .split-content');
    const newSideContent = container.querySelector('.new-side .split-content');
    
    // Synchronized scrolling for split view
    let isScrolling = false;
    
    if (oldSideContent && newSideContent) {
        oldSideContent.addEventListener('scroll', function() {
            if (!isScrolling) {
                isScrolling = true;
                newSideContent.scrollTop = this.scrollTop;
                newSideContent.scrollLeft = this.scrollLeft;
                setTimeout(() => { isScrolling = false; }, 10);
            }
        });
        
        newSideContent.addEventListener('scroll', function() {
            if (!isScrolling) {
                isScrolling = true;
                oldSideContent.scrollTop = this.scrollTop;
                oldSideContent.scrollLeft = this.scrollLeft;
                setTimeout(() => { isScrolling = false; }, 10);
            }
        });
    }
    
    // Handle view toggle
    toggleBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            const view = this.dataset.view;
            
            // Update button states
            toggleBtns.forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            
            // Toggle views
            if (view === 'unified') {
                unifiedView.classList.add('active');
                splitView.classList.remove('active');
            } else {
                unifiedView.classList.remove('active');
                splitView.classList.add('active');
            }
        });
    });
})();
</script>

<style>
.sail-diff-container {
    background: var(--bg-card);
    border: 1px solid #374151;
    border-radius: 8px;
    overflow: hidden;
    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
    font-size: 0.875rem;
}

.diff-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem 1rem;
    background: rgba(139, 92, 246, 0.1);
    border-bottom: 1px solid #374151;
}

.diff-file-info {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    color: var(--text-primary);
}

.diff-labels {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.875rem;
}

.old-label {
    color: #ef4444;
    font-weight: 600;
}

.new-label {
    color: var(--green);
    font-weight: 600;
}

.diff-controls {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.diff-stats {
    display: flex;
    gap: 1rem;
    font-size: 0.875rem;
}

.stat-additions {
    color: var(--green);
    font-weight: 600;
}

.stat-deletions {
    color: #ef4444;
    font-weight: 600;
}

.view-toggle {
    display: flex;
    gap: 0.25rem;
    background: rgba(0, 0, 0, 0.2);
    border-radius: 6px;
    padding: 0.25rem;
}

.toggle-btn {
    padding: 0.375rem 0.75rem;
    border: none;
    background: transparent;
    color: var(--text-secondary);
    border-radius: 4px;
    font-size: 0.8125rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 0.375rem;
}

.toggle-btn:hover {
    background: rgba(139, 92, 246, 0.1);
    color: var(--text-primary);
}

.toggle-btn.active {
    background: var(--purple);
    color: white;
}

.diff-view {
    display: none;
    max-height: 600px;
    overflow-y: auto;
    overflow-x: auto;
}

.diff-view.active {
    display: block;
}

.no-changes-message {
    padding: 2rem;
    text-align: center;
    color: var(--text-secondary);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
}

/* Unified View Styles */
.unified-view .diff-hunk {
    border-bottom: 1px solid #374151;
}

.unified-view .diff-hunk:last-child {
    border-bottom: none;
}

.hunk-header {
    background: rgba(139, 92, 246, 0.05);
    padding: 0.5rem 1rem;
    border-top: 1px solid #374151;
    border-bottom: 1px solid #374151;
}

.hunk-range {
    color: var(--purple);
    font-weight: 600;
    font-size: 0.8125rem;
}

.hunk-table {
    width: 100%;
    border-collapse: collapse;
    background: var(--bg-primary);
}

.diff-line {
    line-height: 1.5;
}

.diff-line:hover {
    background: rgba(139, 92, 246, 0.05);
}

.diff-line-added {
    background: rgba(16, 185, 129, 0.1);
}

.diff-line-added:hover {
    background: rgba(16, 185, 129, 0.15);
}

.diff-line-removed {
    background: rgba(239, 68, 68, 0.1);
}

.diff-line-removed:hover {
    background: rgba(239, 68, 68, 0.15);
}

.line-num {
    width: 50px;
    min-width: 50px;
    text-align: right;
    padding: 0 0.5rem;
    color: var(--text-secondary);
    font-size: 0.75rem;
    user-select: none;
    background: rgba(0, 0, 0, 0.2);
    border-right: 1px solid #374151;
    vertical-align: top;
}

.old-line-num {
    border-right: 1px solid #374151;
}

.diff-line-added .old-line-num {
    background: rgba(239, 68, 68, 0.05);
}

.diff-line-removed .new-line-num {
    background: rgba(16, 185, 129, 0.05);
}

.line-indicator {
    width: 30px;
    min-width: 30px;
    text-align: center;
    padding: 0 0.5rem;
    font-weight: 600;
    user-select: none;
    color: var(--text-secondary);
    vertical-align: top;
}

.diff-line-added .line-indicator {
    color: var(--green);
}

.diff-line-removed .line-indicator {
    color: #ef4444;
}

.line-content {
    padding: 0 1rem;
    color: var(--text-primary);
    white-space: pre;
    overflow-x: auto;
    vertical-align: top;
}

.line-content pre {
    margin: 0;
    padding: 0;
    background: transparent;
    border: none;
    color: inherit;
    font-family: inherit;
    font-size: inherit;
    white-space: pre;
    word-wrap: normal;
    overflow-wrap: normal;
}

/* Split View Styles */
.split-container {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0;
    background: var(--bg-primary);
}

.split-side {
    overflow: hidden;
    border-right: 1px solid #374151;
}

.split-side:last-child {
    border-right: none;
}

.split-header {
    padding: 0.75rem 1rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    border-bottom: 1px solid #374151;
    position: sticky;
    top: 0;
    z-index: 10;
}

.old-side .split-header {
    background: rgba(239, 68, 68, 0.15);
    color: #ef4444;
}

.new-side .split-header {
    background: rgba(16, 185, 129, 0.15);
    color: var(--green);
}

.split-content {
    overflow-y: auto;
    max-height: 550px;
}

.split-hunk {
    border-bottom: 1px solid #374151;
}

.split-hunk:last-child {
    border-bottom: none;
}

.hunk-header-split {
    background: rgba(139, 92, 246, 0.05);
    padding: 0.375rem 1rem;
    border-bottom: 1px solid #374151;
    color: var(--purple);
    font-weight: 600;
    font-size: 0.75rem;
}

.split-table {
    width: 100%;
    border-collapse: collapse;
}

.split-line {
    line-height: 1.5;
}

.split-line:hover {
    background: rgba(139, 92, 246, 0.05);
}

.removed-line {
    background: rgba(239, 68, 68, 0.1);
}

.removed-line:hover {
    background: rgba(239, 68, 68, 0.15);
}

.added-line {
    background: rgba(16, 185, 129, 0.1);
}

.added-line:hover {
    background: rgba(16, 185, 129, 0.15);
}

.split-line-num {
    width: 50px;
    min-width: 50px;
    text-align: right;
    padding: 0 0.5rem;
    color: var(--text-secondary);
    font-size: 0.75rem;
    user-select: none;
    background: rgba(0, 0, 0, 0.2);
    border-right: 1px solid #374151;
    vertical-align: top;
}

.split-line-content {
    padding: 0 1rem;
    color: var(--text-primary);
    white-space: pre;
    overflow-x: auto;
    vertical-align: top;
}

.split-line-content pre {
    margin: 0;
    padding: 0;
    background: transparent;
    border: none;
    color: inherit;
    font-family: inherit;
    font-size: inherit;
    white-space: pre;
    word-wrap: normal;
    overflow-wrap: normal;
}

/* Scrollbar styling */
.diff-view::-webkit-scrollbar,
.split-content::-webkit-scrollbar {
    width: 8px;
    height: 8px;
}

.diff-view::-webkit-scrollbar-track,
.split-content::-webkit-scrollbar-track {
    background: rgba(0, 0, 0, 0.2);
}

.diff-view::-webkit-scrollbar-thumb,
.split-content::-webkit-scrollbar-thumb {
    background: rgba(139, 92, 246, 0.3);
    border-radius: 4px;
}

.diff-view::-webkit-scrollbar-thumb:hover,
.split-content::-webkit-scrollbar-thumb:hover {
    background: rgba(139, 92, 246, 0.5);
}

/* Responsive */
@media (max-width: 1024px) {
    .split-container {
        grid-template-columns: 1fr;
    }
    
    .split-side {
        border-right: none;
        border-bottom: 1px solid #374151;
    }
    
    .split-side:last-child {
        border-bottom: none;
    }
}
</style>
{% endmacro %}
