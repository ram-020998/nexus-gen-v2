{% extends "base.html" %}

{% block title %}Merge Summary - {{ session.reference_id }}{% endblock %}

{% block breadcrumbs %}
<nav class="breadcrumb-nav">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{{ url_for('dashboard') }}"><i class="fas fa-home"></i> Home</a></li>
        <li class="breadcrumb-item"><a href="{{ url_for('merge.sessions') }}">Merge Sessions</a></li>
        <li class="breadcrumb-item active">{{ session.reference_id }}</li>
    </ol>
</nav>
{% endblock %}

{% block page_title %}
    Merge Session Summary
    {% if session.status == 'ready' or session.status == 'in_progress' or session.status == 'completed' %}
        <button id="generateReportBtn" class="btn btn-outline-primary btn-sm float-end">
            <i class="fas fa-file-download"></i> Generate Report
        </button>
    {% endif %}
{% endblock %}
{% block page_subtitle %}{{ session.reference_id }} - Created {{ session.created_at.strftime('%Y-%m-%d %H:%M') }}{% endblock %}

{% block content %}
<!-- Session Status Banner -->
<div class="row mb-4">
    <div class="col-12">
        <div class="status-banner status-{{ session.status }}">
            <div class="status-icon">
                {% if session.status == 'ready' %}
                    <i class="fas fa-check-circle"></i>
                {% elif session.status == 'processing' %}
                    <i class="fas fa-spinner fa-spin"></i>
                {% elif session.status == 'in_progress' %}
                    <i class="fas fa-tasks"></i>
                {% elif session.status == 'completed' %}
                    <i class="fas fa-check-double"></i>
                {% elif session.status == 'error' %}
                    <i class="fas fa-exclamation-triangle"></i>
                {% endif %}
            </div>
            <div class="status-content">
                <h5>
                    {% if session.status == 'ready' %}
                        Analysis Complete - Ready for Review
                    {% elif session.status == 'processing' %}
                        Processing Packages...
                    {% elif session.status == 'in_progress' %}
                        Merge Review In Progress
                    {% elif session.status == 'completed' %}
                        Merge Completed
                    {% elif session.status == 'error' %}
                        Error Processing Packages
                    {% endif %}
                </h5>
                <p class="mb-0">
                    {% if session.status == 'ready' %}
                        All packages have been analyzed. You can now start the merge workflow.
                    {% elif session.status == 'processing' %}
                        Please wait while we extract and analyze your packages...
                    {% elif session.status == 'in_progress' %}
                        Continue reviewing changes to complete the merge.
                    {% elif session.status == 'completed' %}
                        All changes have been reviewed and the merge is complete.
                    {% elif session.status == 'error' %}
                        An error occurred during package processing. Please try again.
                    {% endif %}
                </p>
            </div>
            {% if session.status == 'ready' or session.status == 'in_progress' %}
                {% set first_change = session.changes.filter_by(display_order=1).first() %}
                {% if first_change %}
                    <a href="{{ url_for('merge.get_change_detail', reference_id=session.reference_id, change_id=first_change.id) }}" 
                       class="btn btn-light btn-lg">
                        <i class="fas fa-play-circle"></i> {% if session.status == 'ready' %}Start Merge Workflow{% else %}Continue Review{% endif %}
                    </a>
                {% else %}
                    <a href="{{ url_for('merge.workflow', reference_id=session.reference_id) }}" 
                       class="btn btn-light btn-lg">
                        <i class="fas fa-play-circle"></i> {% if session.status == 'ready' %}Start Merge Workflow{% else %}Continue Review{% endif %}
                    </a>
                {% endif %}
            {% endif %}
        </div>
    </div>
</div>

<!-- What's in the Merge Workflow? -->
<div class="row mb-4">
    <div class="col-12">
        <div class="info-panel">
            <h5 class="panel-title">
                <i class="fas fa-info-circle"></i> What's in the Merge Workflow?
            </h5>
            <p class="text-muted mb-3">
                The merge workflow contains all changes detected between the Base Version (Package A) and the New Vendor Version (Package C). 
                Each change has been analyzed against your Customized Version (Package B) to identify potential conflicts.
            </p>
            <div class="row">
                <div class="col-md-3">
                    <div class="workflow-info-item">
                        <i class="fas fa-check-circle text-success"></i>
                        <strong>No Conflicts:</strong> Changes that don't conflict with your customizations
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="workflow-info-item">
                        <i class="fas fa-exclamation-triangle text-danger"></i>
                        <strong>Conflicts:</strong> Changes that conflict with your customizations and require review
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="workflow-info-item">
                        <i class="fas fa-plus-circle text-info"></i>
                        <strong>New Objects:</strong> Objects added in the new vendor version
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="workflow-info-item">
                        <i class="fas fa-minus-circle text-warning"></i>
                        <strong>Deleted Objects:</strong> Objects deprecated in the new vendor version
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Statistics Overview -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="stat-card">
            <div class="stat-icon bg-primary">
                <i class="fas fa-list"></i>
            </div>
            <div class="stat-content">
                <div class="stat-label">Total Changes</div>
                <div class="stat-value">{{ statistics.total_changes }}</div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card">
            <div class="stat-icon bg-success">
                <i class="fas fa-check"></i>
            </div>
            <div class="stat-content">
                <div class="stat-label">No Conflicts</div>
                <div class="stat-value">{{ statistics.by_classification.NO_CONFLICT or 0 }}</div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card">
            <div class="stat-icon bg-danger">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <div class="stat-content">
                <div class="stat-label">Conflicts</div>
                <div class="stat-value">{{ statistics.by_classification.CONFLICT or 0 }}</div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card">
            <div class="stat-icon bg-info">
                <i class="fas fa-plus"></i>
            </div>
            <div class="stat-content">
                <div class="stat-label">New Objects</div>
                <div class="stat-value">{{ statistics.by_classification.NEW or 0 }}</div>
            </div>
        </div>
    </div>
</div>

<!-- Complexity and Time Estimation -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="stat-card">
            <div class="stat-icon {% if session.estimated_complexity == 'Low' %}bg-success{% elif session.estimated_complexity == 'Medium' %}bg-warning{% else %}bg-danger{% endif %}">
                <i class="fas fa-chart-line"></i>
            </div>
            <div class="stat-content">
                <div class="stat-label">Estimated Complexity</div>
                <div class="stat-value">{{ session.estimated_complexity or 'Calculating...' }}</div>
                <small class="text-muted">Based on conflicts and object types</small>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="stat-card">
            <div class="stat-icon bg-purple">
                <i class="fas fa-clock"></i>
            </div>
            <div class="stat-content">
                <div class="stat-label">Estimated Review Time</div>
                <div class="stat-value">{{ session.estimated_time_hours or 0 }} hours</div>
                <small class="text-muted">Approximate time to review all changes</small>
            </div>
        </div>
    </div>
</div>

<!-- Package Information -->
{% if packages and packages.get('base') %}
<div class="row mb-4">
    <div class="col-12">
        <div class="info-panel">
            <h5 class="panel-title">
                <i class="fas fa-box"></i> Package Information
            </h5>
            <div class="row">
                <div class="col-md-4">
                    <div class="package-info">
                        <span class="badge bg-primary mb-2">Package A</span>
                        <h6>Base Version</h6>
                        <p class="text-muted mb-1">{{ packages.base.filename }}</p>
                        <p class="text-muted mb-0">
                            <i class="fas fa-cube"></i> {{ packages.base.total_objects }} objects
                        </p>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="package-info">
                        <span class="badge bg-success mb-2">Package B</span>
                        <h6>Customized Version</h6>
                        <p class="text-muted mb-1">{{ packages.customized.filename }}</p>
                        <p class="text-muted mb-0">
                            <i class="fas fa-cube"></i> {{ packages.customized.total_objects }} objects
                        </p>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="package-info">
                        <span class="badge bg-info mb-2">Package C</span>
                        <h6>New Vendor Version</h6>
                        <p class="text-muted mb-1">{{ packages.new_vendor.filename }}</p>
                        <p class="text-muted mb-0">
                            <i class="fas fa-cube"></i> {{ packages.new_vendor.total_objects }} objects
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Breakdown by Object Type -->
<div class="row">
    <div class="col-12">
        <div class="info-panel">
            <h5 class="panel-title">
                <i class="fas fa-chart-bar"></i> Breakdown by Object Type
            </h5>
            <div class="object-type-breakdown">
                {% for object_type, count in statistics.by_object_type.items() %}
                <div class="breakdown-item" data-object-type="{{ object_type }}">
                    <div class="breakdown-header" onclick="toggleObjectTypeDetails(this, '{{ session.reference_id }}', '{{ object_type }}')">
                        <div class="breakdown-info">
                            <i class="fas fa-{{ get_object_icon(object_type) }} text-purple"></i>
                            <span class="breakdown-name">{{ object_type }}</span>
                        </div>
                        <div class="breakdown-stats">
                            <span class="badge bg-secondary">{{ count }}</span>
                            <i class="fas fa-chevron-down chevron-icon"></i>
                        </div>
                    </div>
                    <div class="breakdown-details" style="display: none;">
                        <div class="loading-indicator" style="display: none;">
                            <i class="fas fa-spinner fa-spin"></i> Loading objects...
                        </div>
                        <div class="object-grid-container">
                            <!-- Grid will be populated via AJAX -->
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<style>
.status-banner {
    background: var(--bg-card);
    border-radius: 12px;
    padding: 2rem;
    border: 2px solid;
    display: flex;
    align-items: center;
    gap: 1.5rem;
}

.status-banner.status-ready {
    border-color: var(--green);
    background: rgba(16, 185, 129, 0.1);
}

.status-banner.status-processing {
    border-color: #f59e0b;
    background: rgba(245, 158, 11, 0.1);
}

.status-banner.status-in_progress {
    border-color: var(--teal);
    background: rgba(20, 184, 166, 0.1);
}

.status-banner.status-completed {
    border-color: var(--purple);
    background: rgba(139, 92, 246, 0.1);
}

.status-banner.status-error {
    border-color: #ef4444;
    background: rgba(239, 68, 68, 0.1);
}

.status-icon {
    font-size: 3rem;
    flex-shrink: 0;
}

.status-banner.status-ready .status-icon {
    color: var(--green);
}

.status-banner.status-processing .status-icon {
    color: #f59e0b;
}

.status-banner.status-in_progress .status-icon {
    color: var(--teal);
}

.status-banner.status-completed .status-icon {
    color: var(--purple);
}

.status-banner.status-error .status-icon {
    color: #ef4444;
}

.status-content {
    flex: 1;
}

.status-content h5 {
    margin: 0 0 0.5rem 0;
    color: var(--text-primary);
}

.status-content p {
    color: var(--text-secondary);
}

.stat-card {
    background: var(--bg-card);
    border-radius: 12px;
    padding: 1.5rem;
    border: 1px solid #374151;
    display: flex;
    align-items: center;
    gap: 1rem;
    transition: all 0.3s ease;
}

.stat-card:hover {
    border-color: var(--purple);
    transform: translateY(-2px);
}

.stat-icon {
    width: 60px;
    height: 60px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    color: white;
    flex-shrink: 0;
}

.stat-content {
    flex: 1;
}

.stat-label {
    font-size: 0.875rem;
    color: var(--text-secondary);
    margin-bottom: 0.25rem;
}

.stat-value {
    font-size: 2rem;
    font-weight: 700;
    color: var(--text-primary);
}

.info-panel {
    background: var(--bg-card);
    border-radius: 12px;
    padding: 1.5rem;
    border: 1px solid #374151;
}

.panel-title {
    margin: 0 0 1.5rem 0;
    padding-bottom: 1rem;
    border-bottom: 1px solid #374151;
    color: var(--text-primary);
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.package-info {
    padding: 1rem;
    background: rgba(139, 92, 246, 0.05);
    border-radius: 8px;
}

.package-info h6 {
    margin: 0.5rem 0;
    color: var(--text-primary);
}

.object-type-breakdown {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.breakdown-item {
    border: 1px solid #374151;
    border-radius: 8px;
    overflow: hidden;
}

.breakdown-header {
    padding: 1rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: pointer;
    transition: background 0.2s;
}

.breakdown-header:hover {
    background: rgba(139, 92, 246, 0.05);
}

.breakdown-info {
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.breakdown-name {
    font-weight: 500;
    color: var(--text-primary);
}

.breakdown-stats {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.breakdown-details {
    padding: 1rem;
    background: rgba(139, 92, 246, 0.03);
    border-top: 1px solid #374151;
}

.text-purple {
    color: var(--purple);
}

.workflow-info-item {
    padding: 0.75rem;
    background: rgba(139, 92, 246, 0.05);
    border-radius: 8px;
    margin-bottom: 0.5rem;
}

.workflow-info-item i {
    margin-right: 0.5rem;
}

.workflow-info-item strong {
    display: block;
    margin-bottom: 0.25rem;
    color: var(--text-primary);
}

.bg-purple {
    background-color: var(--purple) !important;
}

.bg-warning {
    background-color: #f59e0b !important;
}

.chevron-icon {
    transition: transform 0.3s ease;
}

.chevron-icon.rotated {
    transform: rotate(180deg);
}

.object-grid-container {
    margin-top: 1rem;
}

.object-grid {
    width: 100%;
    border-collapse: collapse;
}

.object-grid th {
    background: rgba(139, 92, 246, 0.1);
    padding: 0.75rem;
    text-align: left;
    font-weight: 600;
    color: var(--text-primary);
    border-bottom: 2px solid #374151;
}

.object-grid td {
    padding: 0.75rem;
    border-bottom: 1px solid #374151;
    color: var(--text-secondary);
}

.object-grid tr:hover {
    background: rgba(139, 92, 246, 0.05);
}

.object-grid .object-name {
    color: var(--text-primary);
    font-weight: 500;
}

.object-grid .object-uuid {
    font-family: monospace;
    font-size: 0.875rem;
}

.loading-indicator {
    padding: 1rem;
    text-align: center;
    color: var(--text-secondary);
}

.classification-badge {
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: 600;
}

.classification-NO_CONFLICT {
    background: rgba(16, 185, 129, 0.2);
    color: var(--green);
}

.classification-CONFLICT {
    background: rgba(239, 68, 68, 0.2);
    color: #ef4444;
}

.classification-NEW {
    background: rgba(20, 184, 166, 0.2);
    color: var(--teal);
}

.classification-DELETED {
    background: rgba(245, 158, 11, 0.2);
    color: #f59e0b;
}

.complexity-badge {
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: 600;
}

.complexity-Low {
    background: rgba(16, 185, 129, 0.2);
    color: var(--green);
}

.complexity-Medium {
    background: rgba(245, 158, 11, 0.2);
    color: #f59e0b;
}

.complexity-High {
    background: rgba(239, 68, 68, 0.2);
    color: #ef4444;
}
</style>
{% endblock %}

{% block scripts %}
<script>
// Auto-refresh if processing
{% if session.status == 'processing' %}
setTimeout(function() {
    location.reload();
}, 5000);
{% endif %}

// Toggle object type details
function toggleObjectTypeDetails(headerElement, referenceId, objectType) {
    const breakdownItem = headerElement.closest('.breakdown-item');
    const detailsDiv = breakdownItem.querySelector('.breakdown-details');
    const chevron = headerElement.querySelector('.chevron-icon');
    const loadingIndicator = detailsDiv.querySelector('.loading-indicator');
    const gridContainer = detailsDiv.querySelector('.object-grid-container');
    
    // Toggle visibility
    if (detailsDiv.style.display === 'none') {
        detailsDiv.style.display = 'block';
        chevron.classList.add('rotated');
        
        // Load data if not already loaded
        if (!gridContainer.hasAttribute('data-loaded')) {
            loadingIndicator.style.display = 'block';
            
            // Fetch object details via AJAX
            fetch(`/merge/${referenceId}/objects/${encodeURIComponent(objectType)}`)
                .then(response => response.json())
                .then(data => {
                    loadingIndicator.style.display = 'none';
                    
                    if (data.success && data.data.objects.length > 0) {
                        // Build grid HTML
                        let gridHtml = `
                            <table class="object-grid">
                                <thead>
                                    <tr>
                                        <th>Object Name</th>
                                        <th>UUID</th>
                                        <th>Classification</th>
                                        <th>Complexity</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                        `;
                        
                        data.data.objects.forEach(obj => {
                            gridHtml += `
                                <tr>
                                    <td class="object-name">${escapeHtml(obj.object_name)}</td>
                                    <td class="object-uuid">${escapeHtml(obj.object_uuid)}</td>
                                    <td>
                                        <span class="classification-badge classification-${obj.classification}">
                                            ${obj.classification}
                                        </span>
                                    </td>
                                    <td>
                                        <span class="complexity-badge complexity-${obj.complexity}">
                                            ${obj.complexity}
                                        </span>
                                    </td>
                                    <td>
                                        <a href="/merge/${referenceId}/changes/${obj.change_id}" 
                                           class="btn btn-sm btn-outline-primary">
                                            <i class="fas fa-eye"></i> View
                                        </a>
                                    </td>
                                </tr>
                            `;
                        });
                        
                        gridHtml += `
                                </tbody>
                            </table>
                        `;
                        
                        gridContainer.innerHTML = gridHtml;
                        gridContainer.setAttribute('data-loaded', 'true');
                    } else {
                        gridContainer.innerHTML = '<p class="text-muted">No objects found.</p>';
                        gridContainer.setAttribute('data-loaded', 'true');
                    }
                })
                .catch(error => {
                    loadingIndicator.style.display = 'none';
                    gridContainer.innerHTML = '<p class="text-danger">Error loading objects. Please try again.</p>';
                    console.error('Error fetching object details:', error);
                });
        }
    } else {
        detailsDiv.style.display = 'none';
        chevron.classList.remove('rotated');
    }
}

// Helper function to escape HTML
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Generate Report button handler
document.addEventListener('DOMContentLoaded', function() {
    const generateReportBtn = document.getElementById('generateReportBtn');
    
    if (generateReportBtn) {
        generateReportBtn.addEventListener('click', function() {
            const referenceId = '{{ session.reference_id }}';
            const btn = this;
            const originalHtml = btn.innerHTML;
            
            // Show loading state
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';
            
            // Trigger report generation
            fetch(`/merge/${referenceId}/report?format=xlsx`, {
                method: 'POST'
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Report generation failed');
                }
                return response.blob();
            })
            .then(blob => {
                // Create download link
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${referenceId}_report.xlsx`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                // Reset button
                btn.disabled = false;
                btn.innerHTML = originalHtml;
                
                // Show success message
                showNotification('Report generated successfully!', 'success');
            })
            .catch(error => {
                console.error('Error generating report:', error);
                btn.disabled = false;
                btn.innerHTML = originalHtml;
                showNotification('Failed to generate report. Please try again.', 'error');
            });
        });
    }
});

// Show notification helper
function showNotification(message, type) {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `alert alert-${type === 'success' ? 'success' : 'danger'} alert-dismissible fade show`;
    notification.style.position = 'fixed';
    notification.style.top = '20px';
    notification.style.right = '20px';
    notification.style.zIndex = '9999';
    notification.style.minWidth = '300px';
    notification.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notification);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        notification.remove();
    }, 5000);
}
</script>
{% endblock %}
